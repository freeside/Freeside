<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
  <TITLE><%= $agent || ( $signup_service eq 'svc_phone' ? 'ITSP' : 'ISP' ) %> Signup form</TITLE>
  <%= $head %>
</HEAD>
<BODY BGCOLOR="<%= $body_bgcolor || '#e8e8e8' %>" onUnload="myclose()">
<%= if ( $terms_of_service =~ /\S/ ) { # enable overlib
  $OUT .= qq!<SCRIPT type="text/javascript" src="$_.js"></SCRIPT>\n!
    foreach (qw(overlibmws overlibmws_iframe overlibmws_draggable 
                overlibmws_crossframe iframecontentmws ));
}
%>
<script type="text/javascript">
  var mywindow = -1;
  function myopen(filename,windowname,properties) {
    myclose();
    mywindow = window.open(filename,windowname,properties);
  }
  function myclose() {
    if ( mywindow != -1 )
      mywindow.close();
    mywindow = -1
  }
</script>
<%= $OUT .= $body_header
      || '<FONT SIZE=7>'.
         ( $agent || ( $signup_service eq 'svc_phone' ? 'ITSP' : 'ISP' ) ).
         ' Signup form</FONT><BR><BR>';
%>

<FONT SIZE="+1" COLOR="#ff0000"><%= $error %></FONT>

<FORM id="form_OneTrueForm" NAME="OneTrueForm" ACTION="<%= $self_url %>" METHOD=POST onSubmit="document.OneTrueForm.signup.disabled=true">
<INPUT TYPE="hidden" id="field_prepaid_shortform" NAME="prepaid_shortform" VALUE="<%= $prepaid_shortform %>">
<INPUT TYPE="hidden" id="field_session" NAME="session" VALUE="<%= $session_id %>">
<INPUT TYPE="hidden" id="field_action" NAME="action" VALUE="process_signup">
<INPUT TYPE="hidden" id="field_agentnum" NAME="agentnum" VALUE="<%= $agentnum %>">
<INPUT TYPE="hidden" id="field_referral_custnum" NAME="referral_custnum" VALUE="<%= $referral_custnum %>">
<INPUT TYPE="hidden" id="field_ss" NAME="ss" VALUE="">
<input type="hidden" id="field_payby" name="payby">
<%=
  $OUT = join("\n",map { my $method = $_ ; map { qq|<input type="hidden" id="field_${method}_$_" class="field_${method}" name="${method}_$_" />| } qw / payinfo payinfo1 payinfo2 payname paystate paytype paycvv month year type  /  } @payby);
%>

<%=
  $OUT = join("\n", map { qq|<input type="hidden" id="field_$_" name="$_" />| } qw / promo_code reg_code pkgpart username _password _password2 sec_phrase popnum mac_addr countrycode phonenum sip_password pin / );
%>

<%=
  if ($override_ban_warn) {
    $OUT .= 'Are you sure you want to sign up again? <SELECT id="field_override_ban_warn" NAME="override_ban_warn"><OPTION VALUE="0">No<OPTION VALUE="1">Yes</SELECT><BR><BR>';
  } else {
    $OUT .= '';
  }
%>

Where did you hear about our service? <SELECT id="field_refnum" NAME="refnum">
<%=
  $OUT .= '<OPTION VALUE="">' unless $refnum;
  foreach my $part_referral ( @part_referral ) {
    $OUT .= '<OPTION VALUE="'. $part_referral->{'refnum'}. '"';
    $OUT .= ' SELECTED' if $part_referral->{'refnum'} == $refnum;
    $OUT .= '>'. $part_referral->{'referral'};
  }
%>
</SELECT><BR><BR>

<%= unless ( $prepaid_template_custnum && $prepaid_shortform  ) {

my $bgcolor = $box_bgcolor || '#c0c0c0';
$OUT .= qq!
Contact Information
<TABLE BGCOLOR="$bgcolor" BORDER=0 CELLSPACING=0 WIDTH="50%" id="table_contactinformation" class="table_form_container">
<TR class="form_field_row">
  <TH ALIGN="right" class="label" id="label_contact_name"><font class="required" color="#ff0000">*</font>Contact name<BR>(last, first)</TH>
  <TD COLSPAN=5><INPUT TYPE="text" id="field_last" NAME="last" VALUE="$last">,
                <INPUT TYPE="text" id="field_first" NAME="first" VALUE="$first"></TD>
</TR>
<TR class="form_field_row">
  <TD ALIGN="right" class="label" id="label_company">Company</TD>
  <TD COLSPAN=5><INPUT TYPE="text" id="field_company" NAME="company" SIZE=70 VALUE="$company"></TD>
</TR>
<TR class="form_field_row">
  <TH ALIGN="right" class="label" id="label_address1"><font class="required" color="#ff0000">*</font>Address</TH>
  <TD COLSPAN=5><INPUT TYPE="text" id="field_address1" NAME="address1" SIZE=70 VALUE="$address1"></TD>
</TR>
<TR class="form_field_row">
  <TD ALIGN="right" class="label" id="label_address2">&nbsp;</TD>
  <TD COLSPAN=5><INPUT TYPE="text" id="field_address2" NAME="address2" SIZE=70 VALUE="$address2"></TD>
</TR>
<TR class="form_field_row">
  <TH ALIGN="right" class="label" id="label_city"><font class="required" color="#ff0000">*</font>City</TH>
  <TD><INPUT TYPE="text" id="field_city" NAME="city" VALUE="$city"></TD> !;

        my ($county_html, $state_html, $country_html) =
          regionselector( {
            selected_county  => $county,
            selected_state   => $state,
            selected_country => $country,
            default_state    => $statedefault,
            default_country  => $countrydefault,
            locales          => \@cust_main_county,
          } );
 
$county_out = ($county_html =~ /SELECT/) ? 'County/State' : 'State';
$OUT .= qq!<TH ALIGN="right" class="label" id="label_countystate"><font class="required" color="#ff0000">*</font> $county_out </TH>
  <TD>
    $county_html $state_html
  </TD>
  <TH class="label" id="label_zip"><font class="required" color="#ff0000">*</font>Zip</TH>
  <TD><INPUT TYPE="text" id="field_zip" NAME="zip" SIZE=10 VALUE="$zip"></TD>
</TR>
<TR class="form_field_row">
  <TH ALIGN="right" class="label" id="label_country"><font class="required" color="#ff0000">*</font>Country</TH>
  <TD>$country_html</TD>
</TR>
<TR class="form_field_row">
  <TD ALIGN="right" class="label" id="label_daytime">Day Phone</TD>
  <TD COLSPAN=5><INPUT TYPE="text" id="field_daytime" NAME="daytime" VALUE="$daytime" SIZE=18></TD>
</TR>
<TR>
  <TD ALIGN="right" class="label" id="label_night">Night Phone</TD>
  <TD COLSPAN=5><INPUT TYPE="text" id="field_night" NAME="night" VALUE="$night" SIZE=18></TD>
</TR>
<TR>
  <TD ALIGN="right" class="label" id="label_fax">Fax</TD>
  <TD COLSPAN=5><INPUT TYPE="text" id="field_fax" NAME="fax" VALUE="$fax" SIZE=12></TD>
</TR>
!;
  if ( $stateid_enabled ) {
    my ($county_html, $state_html, $country_html) =
      regionselector( {
        prefix           => 'stateid_',
        default_state    => $statedefault,
        default_country  => $countrydefault,
        locales          => \@cust_main_county,
      } );
    $OUT .= qq!<TR class="form_field_row">!;
    $OUT .= qq!<TD ALIGN="right" class="label" id="label_stateid">!. $label{stateid}.'</TD>';
    $OUT .= qq!<TD><INPUT TYPE="text" id="field_stateid" NAME="stateid" VALUE="$stateid" SIZE=12></TD>!;
    $OUT .= qq!<TD ALIGN="right" class="label" id="label_stateid_state">!. $label{stateid_state} .'</TD>';
    $OUT .="<TD COLSPAN=3>$county_html $state_html</TD></TR>";
  }
$OUT .= qq!
</TABLE><font class="required" color="#ff0000">*</font> required fields<BR>
!;

}
else {
    @payby = ('PREPAY');
}
%>

<BR>Billing information<TABLE class="table_billinginformation" BGCOLOR="<%= $box_bgcolor || '#c0c0c0' %>" BORDER=0 CELLSPACING=0 WIDTH="40%">
<TR class="form_field_row"><TD>

  <%=
    $OUT ='';
    unless ( $emailinvoiceonly ) { 
    $OUT .= '<INPUT TYPE="checkbox" id="field_invoicing_list_POST" NAME="invoicing_list_POST" VALUE="POST"';
    my @invoicing_list = split(', ', $invoicing_list );
    $OUT .= ' CHECKED'
      if ! @invoicing_list || grep { $_ eq 'POST' } @invoicing_list;
    $OUT .= '>   <span class="label" id="label_invoicing_list_POST">Postal mail invoice</span>'; } 
  %>


</TD></TR>
<TR class="form_field_row"><TD>

    <%=
        $OUT = ( $emailinvoiceonly ?
            q|<font class="required" color="#ff0000">*</font>| :
            q|| );
    %> <span class="label" id"label_invoicing_list">Email invoice</span>
    <INPUT TYPE="text" id="field_invoicing_list" NAME="invoicing_list" VALUE="<%= join(', ', grep { $_ ne 'POST' } split(', ', $invoicing_list ) ) %>">
</TD></TR>
<%= ( scalar(@payby) > 1 or 1 ) ? '<TR class="form_field_row"><TD class="label" id="label_billing_type">Billing type ' : '' %>
<!--</TABLE>
<TABLE BGCOLOR="#c0c0c0" BORDER=1 WIDTH="40%">
<TR>-->

  <%=

    my $cardselect = '<SELECT id="field_card_type" NAME="CARD_type"><OPTION></OPTION>';
    foreach ( keys %card_types ) {
      $selected = $CARD_type eq $card_types{$_} ? 'SELECTED' : '';
      $cardselect .= qq!<OPTION $selected VALUE="$card_types{$_}">$_</OPTION>!;
    }
    $cardselect .= '</SELECT>';
  
    my %payby = (
      'CARD' => qq!Credit card<BR><font class="required"
      color="#ff0000">*</font>$cardselect<INPUT TYPE="text" id="field_card_payinfo" NAME="CARD_payinfo" VALUE="" MAXLENGTH=19><BR><font class="required" color="#ff0000">*</font>Exp !. expselect("CARD"). qq!<BR><font class="required" color="#ff0000">*</font>Name on card<BR><INPUT TYPE="text" id="field_card_payname" NAME="CARD_payname" VALUE="">!,
      'DCRD' => qq!Credit card<BR><font class="required" color="#ff0000">*</font>$cardselect<INPUT TYPE="text" d="field_dcrd_payinfo" NAME="DCRD_payinfo" VALUE="" MAXLENGTH=19><BR><font class="required" color="#ff0000">*</font>Exp !. expselect("DCRD"). qq!<BR><font class="required" color="#ff0000">*</font>Name on card<BR><INPUT TYPE="text" id="field_dcrd_payname" NAME="DCRD_payname" VALUE="">!,
      'CHEK' => qq!Electronic check<BR>${r}Account number <INPUT TYPE="text" id="field_chek_payinfo1" NAME="CHEK_payinfo1" VALUE="" MAXLENGTH=10><BR>${r}ABA/Routing code <INPUT TYPE="text" id="field_chek_payinfo2" NAME="CHEK_payinfo2" VALUE="" SIZE=10 MAXLENGTH=9> Type <SELECT id="field_chek_paytype" NAME="CHEK_paytype">!. join('', map {qq!<OPTION VALUE="$_">$_</OPTION>!} @paytypes). qq!</SELECT><BR>{$r}Bank State <INPUT TYPE="text" id="field_chek_paystate" NAME="CHEK_paystate" VALUE="" SIZE=5 MAXLENGTH=4><INPUT TYPE="hidden" id="field_chek_month" NAME="CHEK_month" VALUE="12"><INPUT TYPE="hidden" id="field_chek_year" NAME="CHEK_year" VALUE="2037"><BR>${r}Bank name <INPUT TYPE="text" id="field_chek_payname" NAME="CHEK_payname" VALUE="">!,
      'DCHK' => qq!Electronic check<BR>${r}Account number <INPUT TYPE="text" id="field_dchk_payinfo1" NAME="DCHK_payinfo1" VALUE="" MAXLENGTH=10> Type <SELECT id="field_dchk_paytype" NAME="DCHK_paytype">!. join('', map {qq!<OPTION VALUE="$_">$_</OPTION>!} @paytypes). qq!</SELECT><BR>${r}ABA/Routing code <INPUT TYPE="text" id="field_dchk_payinfo2" NAME="DCHK_payinfo2" VALUE="" SIZE=10 MAXLENGTH=9><BR>{$r}Bank State <INPUT TYPE="text" id="field_dchk_paystate" NAME="DCHK_paystate" VALUE="" SIZE=5 MAXLENGTH=4><INPUT TYPE="hidden" id="field_dchk_month" NAME="DCHK_month" VALUE="12"><INPUT TYPE="hidden" id="field_dchk_year" NAME="DCHK_year" VALUE="2037"><BR>${r}Bank name <INPUT TYPE="text" id="field_dchk_payname"  NAME="DCHK_payname" VALUE="">!,
      'LECB' => qq!Phone bill billing<BR>${r}Phone number <INPUT TYPE="text" id="field_lecb_payinfo" NAME="LECB_payinfo" VALUE="" MAXLENGTH=15 SIZE=16><INPUT TYPE="hidden" id="field_lecb_month" NAME="LECB_month" VALUE="12"><INPUT TYPE="hidden" id="field_lecb_year" NAME="LECB_year" VALUE="2037"><INPUT TYPE="hidden" id="field_lecb_payname" NAME="LECB_payname" VALUE="">!,
      'BILL' => qq!Billing<BR>P.O. <INPUT TYPE="text" id="field_bill_payinfo" NAME="BILL_payinfo" VALUE=""><BR><INPUT TYPE="hidden" id="field_bill_month" NAME="BILL_month" VALUE="12"><INPUT TYPE="hidden" id="field_bill_year" NAME="BILL_year" VALUE="2037">Attention<INPUT TYPE="text" id="field_bill_payname" NAME="BILL_payname" VALUE="Accounts Payable">!,
      'COMP' => qq!Complimentary<BR><font class="required" color="#ff0000">*</font>Approved by<INPUT TYPE="text" id="field_comp_payinfo" NAME="COMP_payinfo" VALUE=""><BR><font class="required" color="#ff0000">*</font>Exp !. expselect("COMP"),
      'PREPAY' => qq!Prepaid card<BR><font class="required" color="#ff0000">*</font><INPUT TYPE="text" id="field_prepay_info" NAME="PREPAY_payinfo" VALUE="" MAXLENGTH=80>!,
    );

    if ( $cvv_enabled ) {
      foreach my $payby ( grep { exists $payby{$_} } qw(CARD DCRD) ) { #1.4/1.5
        $payby{$payby} .= qq!<TR class="form_field_row"><TD class="label" id="label_${payby}_paycvv" ALIGN="right">CVV2&nbsp;(<A HREF="javascript:myopen('cvv2.html','cvv2','toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=no,resizable=yes,copyhistory=no,width=480,height=288')">help</A>)</TD><TD><INPUT TYPE="text" id="field_${payby}_paycvv" NAME=${payby}_paycvv VALUE="" SIZE=4 MAXLENGTH=4></TD></TR>!;
      }
    }
    if ( $paystate_enabled ) {
      foreach my $payby ( grep { exists $payby{$_} } qw(CHEK DCHK) ) { 
        my ($county_html, $state_html, $country_html) =
          regionselector( {
            prefix           => "${payby}_pay",
            default_state    => $statedefault,
            default_country  => $countrydefault,
            locales          => \@cust_main_county,
          } );
        $payby{$payby} .= "<BR>${r}Bank state $county_html $state_html";
      }
    }

    my( $account, $aba ) = split('@', $payinfo);
    my %paybychecked = (
      'CARD' => '<TABLE BGCOLOR="'. ( $box_bgcolor || '#c0c0c0' ). qq!" BORDER=0 CELLSPACING=0 WIDTH="50%"><TR class="form_field_row"><TD class="label" id="label_card_select" ALIGN="right"><font class="required" color="#ff0000">*</font> Card type</TD><TD>$cardselect</TD></TR><TR class="form_field_row"><TD class="label" id="label_card_payinfo" ALIGN="right"><font class="required" color="#ff0000">*</font> Card number</TD><TD><INPUT TYPE="text" id="field_card_payinfo" NAME="CARD_payinfo" VALUE="$payinfo" MAXLENGTH=19></TD></TR><TR class="form_field_row"><TD class="label" id="label_card_paydate" ALIGN="right"><font class="required" color="#ff0000">*</font> Expration</TD><TD>!. expselect("CARD", $paydate). qq!</TD></TR><TR class="form_field_row"><TD class="label" id="label_card_payname" ALIGN="right"><font class="required" color="#ff0000">*</font> Name on card</TD><TD><INPUT TYPE="text" id="field_card_payname" NAME="CARD_payname" VALUE="$payname"></TD></TR>!,
      'DCRD' => qq!Credit card<BR><font class="required" color="#ff0000">*</font>$cardselect<INPUT TYPE="text" id="field_dcrd_payinfo" NAME="DCRD_payinfo" VALUE="$payinfo" MAXLENGTH=19><BR><font class="required" color="#ff0000">*</font>Exp !. expselect("DCRD", $paydate). qq!<BR><font class="required" color="#ff0000">*</font>Name on card<BR><INPUT TYPE="text" id="field_dcrd_payname" NAME="DCRD_payname" VALUE="$payname">!,
      'CHEK' => qq!Electronic check<BR>${r}Account number <INPUT TYPE="text" id="field_chek_payinfo1" NAME="CHEK_payinfo1" VALUE="$account" MAXLENGTH=10> Type <SELECT id="field_chek_paytype" NAME="CHEK_paytype">!. join('', map {qq!<OPTION VALUE="$_"!.($paytype eq $_ ? 'SELECTED' : '').">$_</OPTION>"} @paytypes). qq!</SELECT><BR>${r}ABA/Routing code <INPUT TYPE="text" id="field_chek_payinfo2" NAME="CHEK_payinfo2" VALUE="$aba" SIZE=10 MAXLENGTH=9><INPUT TYPE="hidden" id="field_chek_month" NAME="CHEK_month" VALUE="12"><INPUT TYPE="hidden" id="field_chek_year" NAME="CHEK_year" VALUE="2037"><BR>${r}Bank name <INPUT TYPE="text" id="field_chek_payname" NAME="CHEK_payname" VALUE="$payname">!,
      'DCHK' => qq!Electronic check<BR>${r}Account number <INPUT TYPE="text" id="field_dchk_payinfo1" NAME="DCHK_payinfo1" VALUE="$account" MAXLENGTH=10> Type <SELECT id="field_dchk_paytype" NAME="DCHK_paytype">!. join('', map {qq!<OPTION VALUE="$_"!.($paytype eq $_ ? 'SELECTED' : '').">$_</OPTION>"} @paytypes). qq!</SELECT><BR>${r}ABA/Routing code <INPUT TYPE="text" id="field_dchk_payinfo2" NAME="DCHK_payinfo2" VALUE="$aba" SIZE=10 MAXLENGTH=9><INPUT TYPE="hidden" id="field_dchk_month" NAME="DCHK_month" VALUE="12"><INPUT TYPE="hidden" id="field_dchk_year" NAME="DCHK_year" VALUE="2037"><BR>${r}Bank name <INPUT TYPE="text" id="field_dchk_payname" NAME="DCHK_payname" VALUE="">!,
      'LECB' => qq!Phone bill billing<BR>${r}Phone number <INPUT TYPE="text" id="field_lecb_payinfo" NAME="LECB_payinfo" VALUE="$payinfo" MAXLENGTH=15 SIZE=16><INPUT TYPE="hidden" id="field_lecb_month" NAME="LECB_month" VALUE="12"><INPUT TYPE="hidden" id="field_lecb_year" NAME="LECB_year" VALUE="2037"><INPUT TYPE="hidden" id="field_lecb_payname" NAME="LECB_payname" VALUE="">!,
      'BILL' => qq!Billing<BR>P.O. <INPUT TYPE="text" id="field_bill_payinfo" NAME="BILL_payinfo" VALUE="$payinfo"><BR><INPUT TYPE="hidden" id="field_bill_month" NAME="BILL_month" VALUE="12"><INPUT TYPE="hidden" id="field_bill_year" NAME="BILL_year" VALUE="2037">Attention<INPUT TYPE="text" id="field_bill_payname" NAME="BILL_payname" VALUE="$payname">!,
      'COMP' => qq!Complimentary<BR><font class="required" color="#ff0000">*</font>Approved by<INPUT TYPE="text" id="field_comp_payinfo" NAME="COMP_payinfo" VALUE="$payinfo"><BR><font class="required" color="#ff0000">*</font>Exp !. expselect("COMP", $paydate),
      'PREPAY' => qq!Prepaid card<BR><font class="required" color="#ff0000">*</font><INPUT TYPE="text" id="field_prepay_payinfo" NAME="PREPAY_payinfo" VALUE="$payinfo" MAXLENGTH=80>!,
    );

    if ( $cvv_enabled ) {
      foreach my $payby ( grep { exists $payby{$_} } qw(CARD DCRD) ) { #1.4/1.5
        $paybychecked{$payby} .= qq!<TR class="form_field_row"><TD ALIGN="right" class="label" id="label_${payby}_paycvv">CVV2&nbsp;(<A HREF="javascript:myopen('cvv2.html','cvv2','toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=no,resizable=yes,copyhistory=no,width=480,height=288')">help</A>)</TD><TD><INPUT TYPE="text" id="field_${payby}_payycvv" NAME=${payby}_paycvv VALUE="$paycvv" SIZE=4 MAXLENGTH=4></TD></TR>!;
      }
    }
    if ( $paystate_enabled ) {
      foreach my $payby ( grep { exists $payby{$_} } qw(CHEK DCHK) ) { 
        my ($county_html, $state_html, $country_html) =
          regionselector( {
            prefix           => "${payby}_pay",
            selected_county  => $county,
            selected_state   => $state,
            selected_country => $country,
            default_state    => $statedefault,
            default_country  => $countrydefault,
            locales          => \@cust_main_county,
          } );
        $paybychecked{$payby} .= "<BR>${r}Bank state $county_html $state_html";
      }
    }

  my %payby_index = ( 'CARD'   => qq/Credit Card/,
                      'DCRD'   => qq/Credit Card/,
                      'CHEK'   => qq/Check/,
                      'DCHK'   => qq/Check/,
                      'LECB'   => qq/Phone Bill Billing/,
                      'BILL'   => qq/Billing/,
                      'COMP'   => qq/Complimentary/,
                      'PREPAY' => qq/Prepaid Card/,
                    );
  

tie my %options, 'Tie::IxHash', ();

foreach my $payby_option ( @payby ) {
  $options{$payby_option} = $payby_index{$payby_option};
}

my $selected_layer = ( grep { $_ eq 'CARD' } @payby ) ? 'CARD' : $payby[0];

HTML::Widgets::SelectLayers->new(
  options => \%options,
  selected_layer => $selected_layer,
  form_name => 'dummy',
  html_between => '</td></tr></table>',
  form_action => 'dummy.cgi',
  layer_callback => sub { my $layer = shift; return ( shift @hide_payment_fields ? '' : $paybychecked{$layer} ) . '</TABLE>'; },
)->html;


  %>

</TR></TABLE><font class="required" color="#ff0000">*</font> required fields
<FORM id="form_signup" name="signup_form" action="<%= $self_url %>" METHOD="POST" onsubmit="return fixup_form();"><BR><BR><span class="label" id="label_first_package">First package</span>
<INPUT TYPE="hidden" id="field_promo_code"  NAME="promo_code" VALUE="<%= $promo_code %>">
<INPUT TYPE="hidden" id="field_reg_code" NAME="reg_code" VALUE="<%= $reg_code %>">
<TABLE BGCOLOR="<%= $box_bgcolor || '#c0c0c0' %>" BORDER=0 CELLSPACING=0 WIDTH="50%">
<TR>
  <TD COLSPAN=2><SELECT id="field_pkgpart" NAME="pkgpart">

  <%=
    $OUT .= '<OPTION VALUE="">(none)'
      unless scalar(@part_pkg) == 1 or $default_pkgpart;
    foreach my $part_pkg ( @part_pkg ) {
      $OUT .= '<OPTION VALUE="'. $part_pkg->{'pkgpart'}. '"';
      $OUT .= ' SELECTED' if $pkgpart && $part_pkg->{'pkgpart'} == $pkgpart;
      $OUT .= '>'. $part_pkg->{'pkg'};
    }
  %>

  </SELECT></TD>
</TR>
<%=
  if ( $signup_service eq 'svc_phone' ) {

    $OUT .= '<TR class="form_field_row"><TD ALIGN="right" class="label" id="label_phonenum">Phone number</TD><TD>'.
            didselector( 'field'   => 'phonenum',
                         'svcpart' => $default_svcpart,
                       ).
            '</TD></TR>';

    $OUT .= <<ENDOUT;
<TR class="form_field_row">
  <TD ALIGN="right" class="label" id="label_pin">Voicemail PIN</TD>
  <TD><INPUT TYPE="pin" id="field_pin" NAME="pin" VALUE="$pin"></TD>
</TR>
ENDOUT

  } else {

    $OUT .= <<ENDOUT;
<TR class="form_field_row">
  <TD ALIGN="right" class="label" id="label_username">Username</TD>
  <TD><INPUT TYPE="text" id="field_username" NAME="username" VALUE="$username"></TD>
</TR>
<TR class="form_field_row">
  <TD ALIGN="right" class="label" id="label_password">Password</TD>
  <TD><INPUT TYPE="password" id="field_password" NAME="_password" VALUE="$_password"></TD>
</TR>
<TR class="form_field_row">
  <TD ALIGN="right" class="label" id="label_password2">Re-enter Password</TD>
  <TD><INPUT TYPE="password" id="field_password2" NAME="_password2" VALUE="$_password2"></TD>
</TR>
ENDOUT

    if ( $security_phrase ) {
      $OUT .= <<SECPHRASE;
<TR class="form_field_row">
  <TD ALIGN="right" class="label" id="label_sec_phrase">Security Phrase</TD>
  <TD><INPUT TYPE="text" id="field_sec_phrase" NAME="sec_phrase" VALUE="$sec_phrase">
  </TD>
</TR>
SECPHRASE
    } else {
      $OUT .= '<INPUT TYPE="hidden" id="field_sec_phrase" NAME="sec_phrase" VALUE="">';
    }

    if ( $nomadix ) {

      warn $mac_addr;
      $mac_addr ||= $MA;
      warn $mac_addr;

      $OUT .= <<NOMADIX;
        <INPUT TYPE="hidden" id="field_mac_addr" NAME="mac_addr" VALUE="$mac_addr">
NOMADIX

    }

  }

  if ( @svc_acct_pop ) {
    $OUT .= '<TR class="form_field_row"><TD ALIGN="right" class="label" id="label_access_number">Access number</TD><TD>'.
            popselector( 'popnum'        => $popnum,
                         'pops'          => \@svc_acct_pop,
                         'init_popstate' => $init_popstate,
                         'popac'         => $popac,
                         'acstate'       => $acstate,
                       ).
            '</TD></TR>';
  } else {
    $OUT .= popselector(popnum=>$popnum, pops=>\@svc_acct_pop);
  }

%>

</TABLE>

<%= 
if ( @optional_packages ) { 
  my @html;
  foreach my $ii ( 0 .. $#optional_packages) {
  my $friendly_index = $ii + 1; 
  if ($optional_packages[$ii]) {
    push @html, qq|<BR>Optional Package #$friendly_index <br />|,'<table bgcolor="#c0c0c0"><tr><td>';

    push @html, qq|<select id="field_optional_package${ii}" name="optional_package${ii}">|;
    push @html, qq|<option value="none"></option>|;
    push @html, map { qq|<option value="$_->{pkgpart}">$_->{pkg}</option>| } @{$optional_packages[$ii]};
    push @html, q|</select>|;
    
    push @html, '</td></tr></table>';
    }
    $OUT = join("\n", @html);
  }  
} else {
$OUT = ''
}
%>
<%=
  if ( $terms_of_service =~ /\S/ ) {
    my $title = 'Terms of Service'; #config?
    my $onclick = qq[overlib( terms_content, CAPTION, "$title", STICKY, AUTOSTATUSCAP, MIDX, 0, MIDY, 0, DRAGGABLE, CLOSECLICK, CLOSETEXT, "Close" );];
    # Container for $terms_of_service to avoid nasty escaping.
    $OUT .= qq[
<BR>
<DIV id="div_terms" style="display:none">$terms_of_service</DIV>
<SCRIPT type="text/javascript">
function agree_to_terms (val) {
  document.getElementById("signup").disabled = !val;
}
function show_terms () {
  overlib( document.getElementById('div_terms').innerHTML,
    CAPTION, '$title', STICKY, AUTOSTATUSCAP, MIDX, 0, MIDY, 0, DRAGGABLE,
    CLOSECLICK, CLOSETEXT, 'Close' );
}
</SCRIPT>
<INPUT TYPE="checkbox" id="field_agree_to_terms" onchange="agree_to_terms(this.checked)">&nbsp;
<span class="label" id="label_agree_to_terms">I agree to the <a href="javascript:void(0);" onclick="show_terms();">Terms of Service</a>.</span>
];
  }
%>
<BR><INPUT TYPE="submit" ID="signup" NAME="signup" VALUE="Signup">
<script language="javascript">
<%= length($terms_of_service) ? 'agree_to_terms(false)' : '' %>

function fixup_form() {
    
    // copy payment method data up to OneTrueForm
    
    var payment_method_elements = new Array( 'payinfo', 'payinfo1', 'payinfo2', 'payname', 'paycvv' , 'paystate', 'paytype', 'month', 'year','type' );
    var payment_method_form_name = document.OneTrueForm.select.options[document.OneTrueForm.select.selectedIndex].value;
    document.OneTrueForm.elements['payby'].value = payment_method_form_name;
    var payment_method_form = document.forms[payment_method_form_name];

    for ( ii = 0 ; ii < payment_method_elements.length ; ii++ ) {
	var true_element_name = payment_method_form_name + '_' + payment_method_elements[ii];
	copyelement ( payment_method_form.elements[true_element_name],
		      document.OneTrueForm.elements[true_element_name] );
    }
    
    // Copy signup details to OneTrueForm
    
    var signup_elements = new Array (
      'promo_code', 'reg_code', 'pkgpart',
      'username', '_password', '_password2', 'sec_phrase', 'popnum',
      'mac_addr',
      'countrycode', 'phonenum', 'sip_password', 'pin'
    );

    for ( ii = 0 ; ii < signup_elements.length ; ii ++ ) {
	copyelement ( document.signup_form.elements[signup_elements[ii]],
		      document.OneTrueForm.elements[signup_elements[ii]]);
    }

    document.OneTrueForm.submit();
    return false;
}

function copyelement(from, to) {
//    alert ( from + ' ' + to );
    
    if ( from == undefined ) {
	to.value = '';
    } else { 
	if ( from.type == 'select-one' ) {
	    to.value = from.options[from.selectedIndex].value;
	} else if ( from.type == 'checkbox' ) {
	    if ( from.checked ) {
		to.value = from.value;
	    } else {
		to.value = '';
	    }
	} else {
	    if ( from.value == undefined ) {
		to.value = '';
	    } else {
		to.value = from.value;
	    }
	}
//	alert(from.name + " (" + from.type + "): " + to.name + " => " + to.value);
    }
}

</script>
</FORM>
<%= $OUT .= $body_footer %>
</BODY>
</HTML>
