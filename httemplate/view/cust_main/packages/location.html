<TD CLASS="inv" BGCOLOR="<% $bgcolor %>">

% unless ( $cust_pkg->locationnum ) {
  <I><FONT SIZE=-1>(<% mt('default service address') |h %>)</FONT><BR>
% }

  <% $loc->location_label( 'join_string'     => '<BR>',
                           'double_space'    => ' &nbsp; ',
                           'escape_function' => \&encode_entities,
                           'countrydefault'  => $countrydefault,
                         )
  %>

% unless ( $cust_pkg->locationnum ) {
  </I>
% }

% if ( ! $cust_pkg->get('cancel')
%      && $FS::CurrentUser::CurrentUser->access_right('Change customer package')
%    )
% {
  <FONT SIZE=-1>
    (&nbsp;<%pkg_change_location_link($cust_pkg)%>&nbsp;)
%   if ( $cust_pkg->locationnum ) {
&nbsp;(&nbsp;<%edit_location_link($cust_pkg->locationnum)%>&nbsp;)
%   }
  </FONT>
% } 

</TD>
<%init>

my $conf = new FS::Conf;
my %opt = @_;

my $bgcolor        = $opt{'bgcolor'};
my $cust_pkg       = $opt{'cust_pkg'};
my $countrydefault = $opt{'countrydefault'} || 'US';
my $statedefault   = $opt{'statedefault'}
                     || ($countrydefault eq 'US' ? 'CA' : '');

my $loc = $cust_pkg->cust_location_or_main;

sub pkg_change_location_link {
  my $cust_pkg = shift;
  my $pkgpart = $cust_pkg->pkgpart;
  include( '/elements/popup_link-cust_pkg.html',
    'action'      => $p. "misc/change_pkg.cgi?locationnum=-1;pkgpart=$pkgpart;".
                     "address1=;address2=;city=;county=;state=$statedefault;".
                     "zip=;country=$countrydefault",
    'label'       => mt('Change location'),
    'actionlabel' => mt('Change'),
    'cust_pkg'    => $cust_pkg,
  );
}

sub edit_location_link {
  my $locationnum = shift;
  include( '/elements/popup_link.html',
    'action'      => $p. "edit/cust_location.cgi?locationnum=$locationnum",
    'label'       => mt('Edit location'),
    'actionlabel' => mt('Edit'),
  );
}

</%init>
