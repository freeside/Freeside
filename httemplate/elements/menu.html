<script type="text/javascript" src="<%$fsurl%>elements/cssexpr.js"></script>

% if ( $opt{'position'} eq 'top' ) {

  <script type="text/javascript" src="<%$fsurl%>elements/xmenu.top.js"></script>
  <link href="<%$fsurl%>elements/xmenu.top.css" type="text/css" rel="stylesheet">

% } else {  # elsif ( $opt{'position'} eq 'left' ) {

  <script type="text/javascript" src="<%$fsurl%>elements/xmenu.js"></script>
  <link href="<%$fsurl%>elements/xmenu.css" type="text/css" rel="stylesheet">

% }

% unless ( $opt{'nocss'} ) {
  <link href="<%$fsurl%>elements/freeside.css" type="text/css" rel="stylesheet">
  <link href="<%$fsurl%>elements/freeside-print.css" type="text/css" rel="stylesheet" media="print">
% }
<link href="<%$fsurl%>elements/freeside-menu.css" type="text/css" rel="stylesheet">

<SCRIPT TYPE="text/javascript">

% my $fs_popup = include( '/elements/popup_link_onclick.html',
%                           'action'      => $fsurl.'docs/about.html',
%                           'label'       => emt('Freeside'),
%                           'style'       => 'color:#999999',
%                           'actionlabel' => emt('About'),
%                           'width'       => 300,
%                           'height'      => 375,
%                           'color'       => '#7e0079',
%                           #'scrolling'   => 'no',
%                       );
% $fs_popup =~ s/return false;//;
  function about_freeside() {
    <% $fs_popup |n %>
  }

  webfxMenuImagePath      = "<%$fsurl%>images/";
  webfxMenuUseHover       = 1;
  webfxMenuShowTime       = 300;
  webfxMenuHideTime       = 500;

  var myBar = new WebFXMenuBar;

% if ( $mobile ) {
%   
%   my( $subhtml, $submenuname ) = submenu(\%menu, 'Freeside');
    <% $subhtml |n %>
    myBar.add(new WebFXMenuButton("Freeside", 
                                  null,
                                  null,
                                  <% $submenuname |n %>));
% }
% else {
%   foreach my $item ( keys %menu ) {
%
%     my( $url_or_submenu, $tooltip ) = @{ $menu{$item} };
%
%     if ( ref($url_or_submenu) ) {
%
%         #warn $item;
%
%         my( $subhtml, $submenuname ) = submenu($url_or_submenu, $item);

          <% $subhtml |n %>
          myBar.add(new WebFXMenuButton(<% mt($item) |js_string %>, null, <% mt($tooltip) |js_string %>, <% $submenuname |n %> ));

%     } else { 
    
          myBar.add(new WebFXMenuButton(<% mt($item) |js_string %>, "<% $url_or_submenu %>", <% mt($tooltip) |js_string %> ));

%     }
%   } #foreach $item
% } #if $mobile

  myBar.show( null, 'vertical' );
  myBar.width = 154;

</SCRIPT>

<%init>
my( %opt ) = @_;
my $conf = new FS::Conf;
my $fsurl = $opt{'freeside_baseurl'};

my $mobile = $opt{'mobile'} || 0;

my $curuser = $FS::CurrentUser::CurrentUser;

# saved searches
tie my %report_saved_searches, 'Tie::IxHash';
if ( my @searches = grep { $_->disabled eq '' } $curuser->saved_search ) {
  foreach my $search (@searches) {
    $report_saved_searches{ $search->searchname } = [
      # don't use query_string here; we don't want to override the format
      $fsurl . $search->path . '?' . $search->params , ''
    ];
  }
  $report_saved_searches{'separator'} = '';
  $report_saved_searches{'My saved searches'} =
    [ $fsurl. 'browse/saved_search.html',
      'Manage saved searches and subscriptions' ];
}

#XXX Active tickets not assigned to a customer

tie my %report_prospects, 'Tie::IxHash';
if ( $curuser->access_right('List prospects') ) {
  $report_prospects{'List prospects'} = [ $fsurl. 'search/prospect_main.html', '' ];
  $report_prospects{'Advanced prospect reports'} = [ $fsurl. 'search/report_prospect_main.html', '' ];
}
$report_prospects{'separator'} = ''
  if $curuser->access_right('List prospects')
  && $curuser->access_right('List contacts');
$report_prospects{'Prospect contacts'} = [ $fsurl. 'search/report_contact.html?link=prospect_main', '' ]
  if $curuser->access_right('List contacts');

tie my %report_quotations, 'Tie::IxHash',
  'List quotations' => [ $fsurl. 'search/quotation.html', '' ],
  'Advanced quotation reports' => [ $fsurl. 'search/report_quotation.html', '' ],
;

tie my %report_customers_lists, 'Tie::IxHash',
  'by customer number' => [ $fsurl. 'search/cust_main.cgi?browse=custnum', '' ],
  'by last name' => [ $fsurl. 'search/cust_main.cgi?browse=last', '' ],
  'by company name' => [ $fsurl. 'search/cust_main.cgi?browse=company', '' ],
;
$report_customers_lists{'by active trouble tickets'} = [ $fsurl. 'search/cust_main.cgi?browse=tickets', '' ]
  if $conf->config('ticket_system');
$report_customers_lists{'with USPS-unvalidated addresses'} = [ $fsurl. 'search/cust_main.cgi?browse=uspsunvalid', '' ]
  if $conf->config('usps_webtools-userid') && $conf->config('usps_webtools-password');

tie my %report_customers, 'Tie::IxHash';
$report_customers{'List customers'} = [ \%report_customers_lists, 'List customers' ]
  if $curuser->access_right('List all customers');
$report_customers{'Zip code distribution'}     = [ $fsurl. 'search/report_cust_main-zip.html', 'Zip codes by number of customers' ];
$report_customers{'Customer signup report'}    = [ $fsurl. 'graph/report_cust_signup.html',    'New customer signups by date' ];
$report_customers{'Customer churn report'} =  [ $fsurl.'graph/report_cust_churn.html', 'New customers, suspensions, and cancellations summary' ];
$report_customers{'Signup date report'}        = [ $fsurl. 'graph/report_signupdate.html',     'Signup date report (by date of signup)' ];
$report_customers{'Advanced customer reports'} = [ $fsurl. 'search/report_cust_main.html',     'by status, signup date, agent, etc.' ]
  if $curuser->access_right('Advanced customer search');
if ( $curuser->access_right('List contacts') ) {
  $report_customers{'separator'} = '';
  $report_customers{'Customer contacts'} = [ $fsurl. 'search/report_contact.html?link=cust_main' ];
  $report_customers{'Customer stored payment information'} = [ $fsurl. 'search/report_cust_payby.html' ];
}

tie my %report_invoices_open, 'Tie::IxHash',
  'All open invoices' => [ $fsurl.'search/cust_bill.html?OPEN_date', 'All invoices with an unpaid balance' ],
  '15 day open invoices' => [ $fsurl.'search/cust_bill.html?OPEN15_date', 'Invoices 15 days or older with an unpaid balance' ],
  '30 day open invoices' => [ $fsurl.'search/cust_bill.html?OPEN30_date', 'Invoices 30 days or older with an unpaid balance' ],
  '60 day open invoices' => [ $fsurl.'search/cust_bill.html?OPEN60_date', 'Invoices 60 days or older with an unpaid balance' ],
  '90 day open invoices' => [ $fsurl.'search/cust_bill.html?OPEN90_date', 'Invoices 90 days or older with an unpaid balance' ],
  '120 day open invoices' => [ $fsurl.'search/cust_bill.html?OPEN120_date', 'Invoices 120 days or older with an unpaid balance' ],
;

tie my %report_invoices, 'Tie::IxHash',
  'Open invoices' => [ \%report_invoices_open, 'Open invoices' ],
  'All invoices'  => [ $fsurl. 'search/cust_bill.html?date', 'List all invoices' ],
  'Advanced invoice reports' => [ $fsurl.'search/report_cust_bill.html', 'by agent, date range, etc.' ],
  'separator'     => '',
  'Line items'    => [ $fsurl. 'search/report_cust_bill_pkg.html', 'Individual line item detail' ],
  'separator'     => '',
  'Voided invoices' => [ $fsurl.'search/report_cust_bill_void.html', 'Search for voided invoices' ],

;

tie my %report_discounts, 'Tie::IxHash',
  'Discount graph'  => [ $fsurl. 'graph/report_cust_bill_pkg_discount.html', 'Discount overview per month' ],
  'Discount detail' => [ $fsurl.'search/report_cust_bill_pkg_discount.html', 'Discount report (by employee and/or date range)' ],
  #awful name
  'Package discounts' => [ $fsurl.'search/report_cust_pkg_discount.html', 'Active/inactive discounts by package' ],
;

tie my %report_services, 'Tie::IxHash';
if ( $curuser->access_right('Configuration') ) {
  $report_services{'Service definitions'} =  [ $fsurl.'browse/part_svc.cgi?orderby=active', 'Service definitions by number of active packages' ];
  $report_services{'separator'} =  '';
}

if ( $curuser->access_right('List services') ) {
  $report_services{'Unprovisioned services'} =  [ $fsurl.'search/report_unprovisioned_services.html', 'Unprovisioned services' ];
  $report_services{'separator2'} =  '';
}

foreach my $svcdb ( FS::part_svc->svc_tables() ) {

  my $name =        "FS::$svcdb"->table_info->{'name_plural'}
             || PL( "FS::$svcdb"->table_info->{'name'}        );
  my $lcname =  "FS::$svcdb"->table_info->{'lcname_plural'} || lc($name);
  my $lcsname = lc("FS::$svcdb"->table_info->{'name'});
  my $longname = "FS::$svcdb"->table_info->{'longname_plural'} || $name;
  my $lclongname = lc($longname);
  my $sorts = "FS::$svcdb"->table_info->{'sorts'} || [ 'svcnum' ];
  $sorts = [ $sorts ] unless ref($sorts);
  my %svc_url = ( 'm'      => $m,
		  'action' => 'search',
		  'svcdb'  => $svcdb,
		);

  tie my %report_svc, 'Tie::IxHash';

  foreach my $sort ( @$sorts ) {

    my $field_info = FS::part_svc->svc_table_fields($svcdb)->{$sort};
    my $label = $field_info->{'label_sort'} || 'by '.$field_info->{'label'};

    my $title = "All $lcname";
    $title .= " $label"
      if scalar(@$sorts) > 1;

    $report_svc{$title} =
      [ svc_url( %svc_url, 'query' => "magic=all;sortby=$sort" ),
        '',
      ];
  }

  if ( $svcdb eq 'svc_acct' ) {

    $report_svc{"All $lcname never logged in"} = 
      [ svc_url( %svc_url, 'query' => "magic=nologin;sortby=svcnum" ),
        '',
      ];

  } elsif ( $svcdb eq 'svc_phone' ) {

    $report_svc{"${name}' total usage by time period"} = 
      [ $fsurl. 'search/report_svc_phone_usage.html',
        'Total usage (minutes, and amount billed) for the specified time period, per phone number.',
      ];
    $report_svc{"${name} by state"} =
      [ $fsurl. 'search/phone_state.html',
        'Current or historical phone services broken down by state.',
      ];

  }

  if ( $curuser->access_right('View/link unlinked services') ) {
    $report_svc{"Unlinked $lcname"} = 
      [ svc_url( %svc_url, 'query' => "magic=unlinked;sortby=". $sorts->[0] ),
        "Pre-Freeside $lcname without a customer record",
      ];
  }

  if ( $curuser->access_right("Services: $name: Advanced search")
    && $svcdb =~ /^svc_(acct|broadband|hardware|phone|fiber)$/ ) {

    $report_svc{"Advanced $lcsname reports"} = 
      [ $fsurl."search/report_$svcdb.html", '' ]
  }

  if ( $svcdb eq 'svc_phone' ) {

    $report_svc{"Phone number (DID) availability"} =
      [ $fsurl."search/report_phone_avail.html", '' ];
    $report_svc{"Inventory/Provisioning Status"} =
      [ $fsurl."search/phone_inventory_provisioned.html", '' ];

  } elsif ( $svcdb eq 'svc_dsl' ) {

    $report_svc{'Qualifications'} = [ $fsurl. 'search/qual.cgi', #XXX qual.html
                                      '',
                                    ];

  }

  $report_services{$name} = [ \%report_svc, $longname ]
    if $curuser->access_right("Services: $name");

}

tie my %report_packages, 'Tie::IxHash';
$report_packages{'Package definitions (by # active)'} =  [ $fsurl.'browse/part_pkg.cgi?active=1', 'Package definitions by number of active packages' ]
  if    $curuser->access_right('Edit package definitions')
     || $curuser->access_right('Edit global package definitions');
$report_packages{'Package costs'} = [ $fsurl.'graph/report_cust_pkg_cost.html', 'Package setup and recurring costs graph' ]
  if $curuser->access_right('Financial reports');
$report_packages{'separator'} =  ''
  if keys %report_packages;
if ( $curuser->access_right('Financial reports') ) {
  $report_packages{'Package churn'} =  [ $fsurl.'graph/report_cust_pkg.html', 'Orders, suspensions and cancellations summary graph' ];
  $report_packages{'separator2'} =  '';
}
$report_packages{'All customer packages'} =  [ $fsurl.'search/cust_pkg.cgi?pkgnum', 'List all customer packages', ];
$report_packages{'Package summary'} = [ $fsurl.'search/cust_pkg_summary.html', 'Show package sales summary', ]
  if $curuser->access_right('Summarize packages');
$report_packages{'Suspended customer packages'} =  [ $fsurl.'search/cust_pkg.cgi?magic=suspended', 'List suspended packages' ];
$report_packages{'Suspension summary'} = [ $fsurl.'search/cust_pkg_susp.html', 'Show suspension activity', ]
  if $curuser->access_right('Summarize packages');
$report_packages{'Customer packages with unconfigured services'} =  [ $fsurl.'search/cust_pkg.cgi?APKG_pkgnum', 'List packages which have provisionable services' ];
$report_packages{'FCC Form 477'} =  [ $fsurl.'search/report_477.html' ]
  if $conf->exists('part_pkg-show_fcc_options');
$report_packages{'Contract end dates'} = [ $fsurl.'search/report_cust_pkg-date.html?date=contract_end', 'Show packages by contract end date' ];
$report_packages{'Advanced package reports'} =  [ $fsurl.'search/report_cust_pkg.html', 'by agent, date range, status, package definition' ];

tie my %report_inventory, 'Tie::IxHash',
  'Inventory by agent' => [ $fsurl.'search/report_agent_inventory.html', '' ],
  'Inventory activity' => [ $fsurl.'search/report_h_inventory_item.html', '' ],
;

tie my %report_rating, 'Tie::IxHash';
$report_rating{'RADIUS sessions'} = [ $fsurl.'search/sqlradius.html', '' ]
  if $curuser->access_right("Usage: RADIUS sessions");
$report_rating{'RADIUS data usage'} = [ $fsurl.'search/report_sqlradius_usage.html', '' ]
  if $curuser->access_right("Usage: RADIUS sessions");
$report_rating{'Call Detail Records (CDRs)'} = [ $fsurl.'search/report_cdr.html', '' ]
  if $curuser->access_right("Usage: Call Detail Records (CDRs)");
$report_rating{'Unrateable CDRs'} = [ $fsurl.'search/cdr.html?freesidestatus=failed;cdrbatchnum=_ALL_' ]
  if $curuser->access_right("Usage: Unrateable CDRs");
$report_rating{'Customer CDRs Profit/Loss'} = [ $fsurl.'search/report_customer_cdr_profit.html', 'Profit/loss from customer CDRs' ]
  if $curuser->access_right('Financial reports');
if ( $curuser->access_right("Usage: Time worked") ) {
  $report_rating{'Time worked'} = [ $fsurl.'search/report_rt_transaction.html', '' ];
  $report_rating{'Time worked summary per ticket'} = [ $fsurl.'search/report_rt_ticket.html', '' ];
  $report_rating{'Time worked summary per customer'} = [ $fsurl.'search/report_rt_cust.html', '' ];
}

tie my %report_ticketing_statistics, 'Tie::IxHash',
  'Tickets per day per Queue'         => [ $fsurl.'rt/RTx/Statistics/CallsQueueDay', 'View the number of tickets created, resolved or deleted in a specific Queue, over the requested period of days' ],
  'Ticket status by Queue'            => [ $fsurl.'rt/RTx/Statistics/OpenStalled', 'View numbers of new, open and stalled tickets in a selected Queue' ],
  'Tickets per day (multiple Queues)' => [ $fsurl.'rt/RTx/Statistics/CallsMultiQueue', 'View tickets created, resolved or deleted on in one or more Queues over a specified time period' ],
  'Tickets per Day of Week'           => [ $fsurl.'rt/RTx/Statistics/DayOfWeek', 'View trends showing when tickets are created, resolved or deleted' ],
  'Time to resolve'                   => [ $fsurl.'rt/RTx/Statistics/Resolution', 'View how long tickets take to be resolved by Queue' ],
  'Time to resolve (scatter graph)'   => [ $fsurl.'rt/RTx/Statistics/TimeToResolve', 'View a detailed scatter graph of time to resolve tickets by Queue' ],
;

tie my %report_ticketing, 'Tie::IxHash',
# fix TimeToResolve extension?  or redo in a more modern way?
#  'Resolved by owner'       => [ $fsurl.'rt/Tools/Reports/ResolvedByOwner.html', '' ],
#  'Resolved in date range'  => [ $fsurl.'rt/Tools/Reports/ResolvedByDates.html', '' ],
#  'Created in date range'   => [ $fsurl.'rt/Tools/Reports/CreatedByDates.html', '' ],
#  'separator'               => '',
  'Statistics'              => [ \%report_ticketing_statistics, '' ],
  'separator2'              => '',
  'Advanced ticket reports' => [ $fsurl.'rt/Search/Build.html?NewQuery=1', 'List tickets by any criteria' ],
;

tie my %report_bill_event, 'Tie::IxHash',
  'Billing event errors' => [ $fsurl.'search/report_cust_event.html?failed=1', 'Failed credit cards, processor or printer problems, etc.' ],
;

tie my %report_payments, 'Tie::IxHash',
  'Payments' => [ $fsurl.'search/report_cust_pay.html', 'Payment report (by type and/or date range)' ],
  'Payment application detail' => [ $fsurl.'search/report_cust_bill_pay_pkg.html', 'Line item application detail' ],
;
$report_payments{'Pending Payments'} = [ $fsurl.'search/cust_pay_pending.html?magic=_date;statusNOT=done', 'Pending real-time payments' ]
  if $curuser->access_right('View customer pending payments');
$report_payments{'Unapplied Payments'} = [ $fsurl.'search/report_cust_pay.html?unapplied=1', 'Unapplied payment report (by type and/or date range)' ];
$report_payments{'Voided Payments'} = [ $fsurl.'search/report_cust_pay.html?void=1', 'Voided payment report (by type and/or date range)' ]
  if $curuser->access_right('View customer pending payments');
$report_payments{'Payment Batches'} = [ $fsurl.'search/pay_batch.html', 'Payment batches (by status and/or date range)' ]
  if $conf->exists('batch-enable') || $conf->config('batch-enable_payby');
$report_payments{'Unapplied Payment Aging'} = [ $fsurl.'search/report_unapplied_cust_pay.html', 'Unapplied payment aging report' ];
$report_payments{'Deleted Payments / Payment history table'} = [ $fsurl.'search/report_h_cust_pay.html', 'Deleted payments / payment history table' ]
  if $conf->exists('payment-history-report');

tie my %report_credits, 'Tie::IxHash',
  'Credit Report' => [ $fsurl.'search/report_cust_credit.html', 'Credit report (by employee and/or date range)' ],
  'Credit package source detail' => [ $fsurl.'search/report_cust_credit_source_bill_pkg.html', 'Line-item detail for triggered package credits' ],
  'Credit application detail' => [ $fsurl.'search/report_cust_credit_bill_pkg.html', 'Line item application detail' ],
  'Unapplied Credits' => [ $fsurl.'search/report_cust_credit.html?unapplied=1', 'Unapplied credit report (by type and/or date range)' ],
  'Voided Credits' => [ $fsurl.'search/report_cust_credit_void.html', 'Voided credit report (by employee and/or date range)' ],
;

tie my %report_refunds, 'Tie::IxHash',
  'Refund Report' => [ $fsurl.'search/report_cust_refund.html', 'Refund report (by type and/or date range)' ],
  'Unapplied Refunds' => [ $fsurl.'search/report_cust_refund.html?unapplied=1', 'Unapplied refund report (by type and/or date range)' ],
;

tie my %report_sales, 'Tie::IxHash',
  'Sales, Credits and Receipts' => [ $fsurl.'graph/report_money_time.html', 'Sales, credits and receipts summary graph' ],
  'Daily Sales, Credits and Receipts' => [ $fsurl.'graph/report_money_time_daily.html', 'Sales, credits and receipts (broken down by day) summary graph' ],
  'Sales Report' => [ $fsurl.'graph/report_cust_bill_pkg.html', 'Sales report and graph (by agent, package class and/or date range)' ],
  'Rated Call Sales Report' => [ $fsurl.'graph/report_cust_bill_pkg_detail.html', 'Sales report and graph (by agent, package class, usage class and/or date range)' ],
  'Sales with Advertising Source' => [ $fsurl.'search/report_cust_bill_pkg_referral.html' ],
;

tie my %report_commissions, 'Tie::IxHash',
  'Agent' => [ $fsurl.'search/report_agent_commission.html' ],
  'Agent per package' => [ $fsurl.'search/report_agent_commission_pkg.html' ],
  'Sales Person' => [ $fsurl.'search/report_sales_commission.html' ],
  'Sales Person per package' => [ $fsurl.'search/report_sales_commission_pkg.html' ],
  'Employee' => [ $fsurl.'search/report_employee_commission.html', '' ],
  'Agent Credits and Payments' => [ $fsurl.'search/report_agent_credit_payment.html' ],
;

tie my %report_financial, 'Tie::IxHash';
if( $curuser->access_right('Financial reports') ) {

  %report_financial = (
    'Sales'       => [ \%report_sales, 'Sales reports', ],
    'Commissions' => [ \%report_commissions, 'Commission reports', ],
    'Credits'     => [ \%report_credits, 'Credit reports', ],
    'Refunds'     => [ \%report_refunds, 'Refund reports', ],
  );
  $report_financial{'A/R Aging'} = [ $fsurl.'search/report_receivables.html', 'Accounts Receivable Aging report' ];
  $report_financial{'Prepaid Income'} = [ $fsurl.'search/report_prepaid_income.html', 'Prepaid income (unearned revenue)  report' ];

  my $taxproducts = $conf->config('tax_data_vendor');
  $report_financial{'Tax Liability'. ($taxproducts ? ' (internal tax data)' : '')} = [ $fsurl.'search/report_tax.html', 'Tax liability report (internal tax data)' ];
  $report_financial{'Tax Liability (vendor tax data)'} = [ $fsurl.'search/report_newtax.html', 'Tax liability report (vendor tax data)' ]
    if $taxproducts;

  $report_financial{'Monthly Sales and Taxes'} = [$fsurl.'search/tax_sales.html', 'Monthly sales and taxes report'];

  # most sites don't need this but there isn't really a config to enable it
  $report_financial{'E911 Fee Summary'} = [ $fsurl.'search/report_e911.html', 'E911 fee summary' ];

  $report_financial{'Customer Accounting Summary'} = [ $fsurl.'search/report_customer_accounting_summary.html', 'Customer accounting summary report' ];

} elsif($curuser->access_right('Receivables report')) {

  $report_financial{'A/R Aging'} = [ $fsurl.'search/report_receivables.html', 'Accounts Receivable Aging report' ];

} # else $report_financial contains nothing.

tie my %report_payable, 'Tie::IxHash',
  'Payables summary' => [ $fsurl. 'search/report_vend_main.html', 'Payables summary by vendor' ],
  'Payables detail' => [ $fsurl. 'search/report_vend_bill.html' ],
;

tie my %report_logs, 'Tie::IxHash';
$report_logs{'Billing events'} =  [ $fsurl.'search/report_cust_event.html', 'Search billing events by date and status' ]
  if $curuser->access_right('Billing event reports');
$report_logs{'Credit limit incidents'} = [ $fsurl.'search/report_cust_main_credit_limit.html', '' ]
  if $curuser->access_right('List rating data');
$report_logs{'Employee activity'} = [ $fsurl.'search/report_employee_audit.html', '' ]
  if $curuser->access_right('Employees: Audit Report');
$report_logs{'System log'} = [ $fsurl.'search/log.html', 'View system events and debugging information.' ],
  if $curuser->access_right('View system logs')
  || $curuser->access_right('Configuration');
$report_logs{'Outgoing messages'} = [ $fsurl.'search/cust_msg.html', 'View outgoing message log' ]
  if $curuser->access_right('View email logs')
  || $curuser->access_right('Configuration');

tie my %report_menu, 'Tie::IxHash';
$report_menu{'Saved searches'} = [ \%report_saved_searches, 'My saved searches' ]
  if keys(%report_saved_searches);
$report_menu{'Prospects'}      = [ \%report_prospects, 'Prospect reports' ]
  if $curuser->access_right('List prospects')
  || $curuser->access_right('List contacts');
$report_menu{'Quotations'}     = [ \%report_quotations, 'Quotation reports' ]
  if $curuser->access_right('List quotations');
$report_menu{'Customers'}      = [ \%report_customers, 'Customer reports'  ]
  if $curuser->access_right('List customers')
  || $curuser->access_right('List contacts');
$report_menu{'Invoices'}       =  [ \%report_invoices,  'Invoice reports'   ]
  if $curuser->access_right('List invoices');
$report_menu{'Discounts'}      =  [ \%report_discounts, 'Discount reports'  ]
  if $curuser->access_right('Financial reports');
$report_menu{'Payments'}       =  [ \%report_payments,  'Payment reports'   ]
  if $curuser->access_right('Financial reports');
$report_menu{'Packages'}       =  [ \%report_packages,  'Package reports'   ]
  if $curuser->access_right('List packages');
$report_menu{'Services'}       =  [ \%report_services,  'Services reports'  ]
  if $curuser->access_right('List services');
$report_menu{'Inventory'}      =  [ \%report_inventory,  'Inventory reports'  ]
  if $curuser->access_right('Configuration'); #XXX List inventory?
$report_menu{'Usage'}          =  [ \%report_rating,    'Usage reports'  ]
  if $curuser->access_right('List rating data');
$report_menu{'Tickets'}        = [ \%report_ticketing, 'Ticket reports' ]
  if $conf->config('ticket_system')
  ;#&& FS::TicketSystem->access_right(\%session, 'Something');
$report_menu{'Financial (Receivables)'} = [ \%report_financial, 'Financial reports (Receivables)' ]
  if $curuser->access_right('Financial reports') 
  or $curuser->access_right('Receivables report');
$report_menu{'Financial (Payables)'} = [ \%report_payable, 'Financial reports (Payables)' ]
  if $curuser->access_right('Financial reports');

$report_menu{'Logs'}           = [ \%report_logs, 'System and email logs' ]
  if (keys %report_logs); # empty if the user has no rights to it
$report_menu{'SQL Query'}      = [ $fsurl.'search/report_sql.html', 'SQL Query']
  if $curuser->access_right('Raw SQL');

tie my %tools_customers, 'Tie::IxHash', ();
$tools_customers{'Appointments'} = [ $fsurl.'rt/Search/Schedule.html?LengthMin=0', 'View appointment schedule' ]
  if $curuser->access_right('View appointments');
$tools_customers{'Attachments'} = [ $fsurl.'browse/cust_attachment.html', 'View customer attachments' ]
  if !$conf->config('disable_cust_attachment') and $curuser->access_right('View attachments') and $curuser->access_right('Browse attachments');
$tools_customers{'Customer email settings'} = [ $fsurl.'misc/manage_cust_email.html' ]
  if $curuser->access_right('Edit customer');

tie my %tools_billing, 'Tie::IxHash', ();
$tools_billing{'Quick payment entry'} =  [ $fsurl.'misc/batch-cust_pay.html', 'Enter multiple payments in a batch' ]
  if $curuser->access_right('Post payment batch');
$tools_billing{'Process payment batches'} = [ $fsurl.'search/pay_batch.cgi?magic=_date;open=1;intransit=1', 'Process credit card and electronic check batches' ]
  if ( $conf->exists('batch-enable') || $conf->config('batch-enable_payby') )
     && $curuser->access_right('Process batches');
$tools_billing{'Download invoice batches'} = [ $fsurl.'search/bill_batch.cgi' ]
  if $curuser->access_right('Process invoice batches')
  || $curuser->access_right('Process global invoice batches')
  || $curuser->access_right('Configuration'); #XXX remove in 2.5
  #now there's a standalone event#if $conf->exists('invoice_print_pdf');

tie my %tools_importing, 'Tie::IxHash',
  'Customers'            => [ $fsurl.'misc/cust_main-import.cgi', '' ],
  'Package definitions'  => [ $fsurl.'misc/part_pkg-import.html', '' ],
  'Customer packages'    => [ $fsurl.'misc/cust_pkg-import.html', '' ],
  'Customer notes'       => [ $fsurl.'misc/cust_main_note-import.html', '' ],
  'One-time charges'     => [ $fsurl.'misc/cust_main-import_charges.cgi', '' ],
  'Payments'             => [ $fsurl.'misc/cust_pay-import.cgi', '' ],
  'Credits'              => [ $fsurl.'misc/cust_credit-import.html', '' ],
  'Phone numbers (DIDs)' => [ $fsurl.'misc/phone_avail-import.html', '' ],
  'Call Detail Records (CDRs)' => [ $fsurl.'misc/cdr-import.html', '' ],
;
if ( $conf->config('tax_data_vendor') eq 'cch' ) {
  if ( $conf->exists('taxdatadirectdownload') ) {
      $tools_importing{'Tax rates from vendor site'} =
      [ $fsurl.'misc/tax-fetch_and_import.cgi', '' ];
  } else {
    $tools_importing{'Tax rates from CSV files'} =
      [ $fsurl.'misc/tax-import.cgi', '' ];
  }
}

tie my %tools_misc, 'Tie::IxHash', ();
$tools_misc{'Bulk DID Orders'} =  [ $fsurl.'browse/did_order.html', 'View/manage bulk DID orders' ]
  if $curuser->access_right('Import');
$tools_misc{'Business card scan'} = [ $fsurl.'edit/prospect_main-upload.html' ]
  if $curuser->access_right('New prospect');
$tools_misc{'Time Queue'} =  [ $fsurl.'search/report_timeworked.html', 'View pending support time' ]
  if $curuser->access_right('Time queue');

#tie my %tools_exporting, 'Tie::IxHash',
#  'Download database dump' => [ $fsurl. 'misc/dump.cgi', '' ],
#;

tie my %tools_ticketing_articles, 'Tie::IxHash',
  'Overview' => [ $fsurl.'rt/Articles/index.html', '' ],
  'Search'   => [ $fsurl.'rt/Articles/Article/Search.html', '' ],
  'Topics'   => [ $fsurl.'rt/Articles/Topics.html', '' ],
;

tie my %tools_ticketing, 'Tie::IxHash',
  'Articles'     => [ \%tools_ticketing_articles, '' ],
  'My Day'       => [ $fsurl.'rt/Tools/MyDay.html', '' ],
  'My Reminders' => [ $fsurl.'rt/Tools/MyReminders.html', '' ],
  'Offline'      => [ $fsurl.'rt/Tools/Offline.html', '' ],
  'Approval'     => [ $fsurl.'rt/Approvals/', '' ],
;
$tools_ticketing{'Cron Tool'} = [ $fsurl.'rt/Developer/CronTool/', '' ]
  if $conf->exists('rt-crontool');

tie my %tools_system, 'Tie::IxHash', ();
$tools_system{'Status'} = [ $fsurl.'view/Status.html', 'System status' ]
  if $curuser->access_right('Configuration'); # 'View system status');
$tools_system{'Job Queue'} =  [ $fsurl.'search/queue.html', 'View pending job queue' ]
  if $curuser->access_right('Job queue');
$tools_system{'Access log statistics'} = [ $fsurl.'search/report_access_user_log.html?group_by=path', '' ]
  if $curuser->access_right('Configuration'); # 'View profiling data');

tie my %tools_menu, 'Tie::IxHash', ();
$tools_menu{'Customers'} = [ \%tools_customers, 'Customer tools' ]
  if keys %tools_customers;
$tools_menu{'Billing'} = [ \%tools_billing, 'Payment and invoice tools' ]
  if keys %tools_billing;
$tools_menu{'Ticketing'} = [ \%tools_ticketing, 'Ticketing tools' ]
  if $conf->config('ticket_system');
$tools_menu{'Miscellaneous'} = [ \%tools_misc, '' ]
  if keys %tools_misc;
$tools_menu{'Importing'} =  [ \%tools_importing, 'Import tools' ]
  if $curuser->access_right('Import');
#$tools_menu{'Exporting'} =  [ \%tools_exporting, 'Export tools' ]
#  if $curuser->access_right('Export');
$tools_menu{'System'} = [ \%tools_system, 'System tools' ]
  if keys %tools_menu;

tie my %config_employees, 'Tie::IxHash',
  'Employees' => [ $fsurl.'browse/access_user.html', 'Setup internal users' ],
  'Employee groups' => [ $fsurl.'browse/access_group.html', 'Employee groups allow you to control access to the backend' ],
  'Installer availability' => [ $fsurl.'browse/sched_item.html', 'Installer availability' ],
;

tie my %config_dialup, 'Tie::IxHash',
  'Access numbers' => [ $fsurl.'browse/svc_acct_pop.cgi', 'Points of Presence' ],
;

tie my %config_broadband, 'Tie::IxHash',
  'Towers'         => [ $fsurl.'browse/tower.html', 'Towers and sectors' ],
  'Routers'        => [ $fsurl.'browse/router.cgi', 'Broadband access routers' ],
  'Address blocks' => [ $fsurl.'browse/addr_block.cgi', 'Manage address blocks and block assignments to broadband routers' ],
;
if ( $curuser->access_right('Broadband global configuration') ) {
  $config_broadband{'Address ranges'} = 
                      [ $fsurl.'browse/addr_range.html', 'Designate special address ranges' ];
}

tie my %config_phone, 'Tie::IxHash',
  'View/Edit phone device types' => [ $fsurl.'browse/part_device.html', 'Phone device types' ],
  'View/Edit bulk DID vendors' => [ $fsurl.'browse/did_vendor.html', 'Bulk DID vendors' ],
  'View/Edit Carriers' => [ $fsurl.'browse/cdr_carrier.html', 'Carriers' ],
;

tie my %config_radius, 'Tie::IxHash',
  'RADIUS Groups' => [ $fsurl.'browse/radius_group.html', 'Manage RADIUS groups' ],
  'RADIUS Clients' => [ $fsurl.'browse/nas.html', 'Manage RADIUS clients' ],
;

tie my %config_cable, 'Tie::IxHash',
  'Cable providers' => [ $fsurl.'browse/cable_provider.html', '' ],
  'Cable modem models' => [ $fsurl.'browse/cable_model.html', '' ],
;

tie my %config_alarm, 'Tie::IxHash',
  'Alarm system vendors'   => [ $fsurl.'browse/alarm_system.html', '' ],
  'Alarm system types'     => [ $fsurl.'browse/alarm_type.html', '' ],
  'Alarm central stations' => [ $fsurl.'browse/alarm_station.html', '' ],
;

tie my %config_conferencing, 'Tie::IxHash',
  'Conferencing types' => [ $fsurl.'browse/conferencing_type.html', '' ],
  'Quality levels'     => [ $fsurl.'browse/conferencing_quality.html', '' ],
;

tie my %config_circuit, 'Tie::IxHash',
  'Circuit types'     => [ $fsurl.'browse/circuit_type.html',         '' ],
  'Circuit providers' => [ $fsurl.'browse/circuit_provider.html',     '' ],
  'Termination types' => [ $fsurl.'browse/circuit_termination.html',  '' ],
;

tie my %config_fiber, 'Tie::IxHash',
  'OLTs' => [ $fsurl.'browse/fiber_olt.html', '' ],
;

tie my %config_export_svc, 'Tie::IxHash', ();
if ( $curuser->access_right('Configuration') ) {
  $config_export_svc{'Service definitions'} = [ $fsurl.'browse/part_svc.cgi', 'Services are items you offer to your customers' ];
  $config_export_svc{'Service classes'} = [ $fsurl.'browse/part_svc_class.html', 'Services classes are user-defined, informational types for services' ];
  $config_export_svc{'Service dependencies'} = [ $fsurl.'browse/part_svc_link.html', 'Services depencies define rules between service definitions' ];
  $config_export_svc{'Provisioning exports'} = [ $fsurl.'browse/part_export.cgi', 'Provisioning services to external machines, databases and APIs' ];
}
$config_export_svc{'Dialup'}  = [ \%config_dialup, ''    ]
  if $curuser->access_right('Dialup configuration');
$config_export_svc{'Wireless broadband'} = [ \%config_broadband, ''    ]
  if $curuser->access_right('Broadband configuration');
$config_export_svc{'Phone'}  = [ \%config_phone, ''    ]
  if $curuser->access_right('Configuration');
$config_export_svc{'RADIUS'} = [ \%config_radius, '' ]
  if $curuser->access_right('Configuration');
$config_export_svc{'Cable'} = [ \%config_cable, '' ]
  if $curuser->access_right('Configuration');
$config_export_svc{'Conferencing'} = [ \%config_conferencing, '' ]
  if $curuser->access_right('Configuration');
$config_export_svc{'Alarm'} = [ \%config_alarm, '' ]
  if $curuser->access_right(['Alarm configuration', 'Alarm global configuration']);
$config_export_svc{'Circuits'} = [ \%config_circuit, '' ]
  if $curuser->access_right('Configuration');
$config_export_svc{'Fiber'} = [ \%config_fiber, '' ]
  if $curuser->access_right('Configuration');
$config_export_svc{'Hardware types'} = [ $fsurl.'browse/hardware_class.html', 'Set up hardware type catalog' ]
  if $curuser->access_right('Configuration');

tie my %config_pkg_reason, 'Tie::IxHash',
  'Cancel reasons' => [ $fsurl.'browse/reason_type.html?class=C', 'Cancel reasons explain why a service was cancelled.' ],
  'Suspend reasons' => [ $fsurl.'browse/reason_type.html?class=S', 'Suspend reasons explain why a service was suspended.' ],
;

tie my %config_pkg, 'Tie::IxHash', ();
$config_pkg{'Package definitions'} = [ $fsurl.'browse/part_pkg.cgi', 'One or more services are grouped together into a package and given pricing information. Customers purchase packages, not services' ]
  if    $curuser->access_right('Edit package definitions')
     || $curuser->access_right('Edit global package definitions');
if ( $curuser->access_right('Configuration') ) {

  #package grouping sub-menu?
  $config_pkg{'Package classes'} =  [ $fsurl.'browse/pkg_class.html', 'Package classes define groups of packages, for taxation, ordering convenience and reporting.' ];
  $config_pkg{'Package categories'} =  [ $fsurl.'browse/pkg_category.html', 'Package categories define groups of package classes, for invoice sections.' ];
  $config_pkg{'Package report classes'} =  [ $fsurl.'browse/part_pkg_report_option.html', 'Package classes define optional groups of packages for reporting only.' ];
  #eo package grouping sub-menu

  if ( $curuser->access_right([ 'Edit fee definitions',
                                'Edit global fee definitions' ]) ) {
    $config_pkg{'Fees'} = [ $fsurl.'browse/part_fee.html', '' ];
  }
  $config_pkg{'Discounts'} = [ $fsurl.'browse/discount.html', '' ];
  $config_pkg{'Discount classes'} = [ $fsurl.'browse/discount_class.html', '' ];
  $config_pkg{'Cancel/Suspend Reasons'} = [ \%config_pkg_reason, '' ];
}

tie my %config_cust, 'Tie::IxHash',
  'Customer tags'       => [ $fsurl.'browse/part_tag.html', '' ],
  'Customer classes'    =>  [ $fsurl.'browse/cust_class.html', 'Customer classes define groups of customers for reporting.' ],
  'Customer categories' =>  [ $fsurl.'browse/cust_category.html', 'Customer categories define groups of customer classes.' ],
  'separator'     => '', #its a separator!
  'Contact types'    =>  [ $fsurl.'browse/contact_class.html', ''], #XXX useful description
;
  
$config_cust{'Note classes'} = [ $fsurl.'browse/cust_note_class.html', 'Note classes define groups of customer notes for reporting.' ];

tie my %config_agent, 'Tie::IxHash',
  'Agent types' => [ $fsurl.'browse/agent_type.cgi', 'Agent types define groups of package definitions that you can then assign to particular agents' ],
  'Agents'      => [ $fsurl.'browse/agent.cgi', 'Agents are resellers of your service. Agents may be limited to a subset of your full offerings (via their type)' ],
  'Agent payment gateways'         => [ $fsurl.'browse/payment_gateway.html', 'Credit card and electronic check processors for agent overrides' ];
;

tie my %config_sales, 'Tie::IxHash',
  'Sales People' => [ $fsurl.'browse/sales.html', 'Sales people bring in new business.' ],
;

tie my %config_billing_rates, 'Tie::IxHash';
$config_billing_rates{'Rate plans'} = [ $fsurl.'browse/rate.cgi', 'Manage rate plans' ]
  if $curuser->access_right('Edit CDR rates')
  #|| $curuser->access_right('Edit global CDR rates')
  || $curuser->access_right('Configuration');
if ( $curuser->access_right('Configuration') ) {
  $config_billing_rates{'Regions and prefixes'} = [ $fsurl.'browse/rate_region.html', 'Manage regions and prefixes' ];
  $config_billing_rates{'Usage classes'} = [ $fsurl.'browse/usage_class.html', 'Usage classes define groups of usage for taxation.' ];
  $config_billing_rates{'Time periods'} = [ $fsurl.'browse/rate_time.html', 'Time periods define days and hours for rate plans' ];
  $config_billing_rates{'Edit rates with Excel'} = [ $fsurl.'misc/rate_edit_excel.html', 'Download and edit rates with Excel, then upload changes.' ]; #"Edit with Excel" ?
  $config_billing_rates{'separator'} = ''; #its a separator!
  $config_billing_rates{'Tiering plans'} = [ $fsurl.'browse/rate_tier.html', 'Rating tiers' ];
}

tie my %config_billing, 'Tie::IxHash';
#  'Payment gateways'         => [ $fsurl.'browse/payment_gateway.html', 'Credit card and electronic check processors' ];
$config_billing{'Billing events'} = [ $fsurl.'browse/part_event.html', 'Billing actions for customers, invoices and packages' ]
    if $curuser->access_right('Edit billing events')
    || $curuser->access_right('Edit global billing events');
if ( $curuser->access_right('Configuration') ) {
  $config_billing{'Invoice configurations'}      = [ $fsurl.'browse/invoice_conf.html', 'Adjust invoice settings for special-purpose notices' ];
  $config_billing{'Invoice templates'}      = [ $fsurl.'browse/invoice_template.html', 'Edit templates for HTML, plaintext and typeset invoices' ];
  $config_billing{'separator'} = ''; #its a separator!
  $config_billing{'Prepaid cards'}          = [ $fsurl.'search/prepay_credit.html', 'View outstanding cards, generate new cards' ];
}
$config_billing{'Call rates and regions'} = [ \%config_billing_rates, 'Manage rate plans, regions and prefixes for VoIP and call billing' ]
  if keys %config_billing_rates;
if ( $curuser->access_right('Configuration') ) {
  $config_billing{'separator2'} = ''; #its a separator!

  my $config_taxes_name = 'Locales and tax rates'.
                          ( $conf->config('tax_data_vendor')
                            ? ' (internal tax class system)'
                            : ''
                          );
  $config_billing{$config_taxes_name}  = [ $fsurl.'browse/cust_main_county.cgi', 'Change tax rates, or break down a country into states, or a state into counties and assign different tax rates to each' ];
  $config_billing{'Tax rates (vendor data tax products system)'}  = [ $fsurl.'browse/tax_rate.cgi', 'Edit tax rates for the vendor data tax products system' ]
     if $conf->config('tax_data_vendor');
  $config_billing{'Tax classes'} = [ $fsurl. 'browse/part_pkg_taxclass.html', 'Tax classes' ];

  if ( $conf->config('currencies') ) {
    $config_billing{'separator3'} = ''; #its a separator!
    $config_billing{'Exchange rates'} = [ $fsurl.'edit/currency_exchange.html', 'Currency exchange rates' ];
  }

  $config_billing{'separator4'} = ''; #its a separator!
  $config_billing{'Credit reasons'}  = [ $fsurl.'browse/reason_type.html?class=R', 'Credit reasons explain why a credit was issued.' ];
  
  $config_billing{'Refund reasons'}  = [ $fsurl.'browse/reason_type.html?class=F', 'Refund reasons explain why a refund was issued.' ];

  $config_billing{'Invoice void reasons'}  = [ $fsurl.'browse/reason_type.html?class=I', 'Invoice void reasons explain why an invoice was voided.' ];
  $config_billing{'Payment void reasons'}  = [ $fsurl.'browse/reason_type.html?class=P', 'Payment void reasons explain why a payment was voided.' ];
  $config_billing{'Credit void reasons'}  = [ $fsurl.'browse/reason_type.html?class=X', 'Credit void reasons explain why a credit was voided.' ];
}

#XXX also to be unified
tie my %config_ticketing_groups, 'Tie::IxHash',
  'Select' => [ $fsurl.'rt/Admin/Groups', '' ],
  'Create' => [ $fsurl.'rt/Admin/Groups/Modify.html?Create=1', '' ],
;

tie my %config_ticketing_queues, 'Tie::IxHash',
  'Select' => [ $fsurl.'rt/Admin/Queues', '' ],
  'Create' => [ $fsurl.'rt/Admin/Queues/Modify.html?Create=1', '' ],
;

tie my %config_ticketing_customfields, 'Tie::IxHash',
  'Select' => [ $fsurl.'rt/Admin/CustomFields', '' ],
  'Create' => [ $fsurl.'rt/Admin/CustomFields/Modify.html?Create=1', '' ],
;

tie my %config_ticketing_articles_classes, 'Tie::IxHash',
  'Select' => [ $fsurl.'rt/Admin/Articles/Classes/', '' ],
  'Create' => [ $fsurl.'rt/Admin/Articles/Classes/Modify.html?Create=1', '' ],
;

tie my %config_ticketing_articles_customfields, 'Tie::IxHash',
  'Select' => [ $fsurl.'rt/Admin/CustomFields/index.html?type=RT%3A%3AClass-RT%3A%3AArticle', '' ],
  'Create' => [ $fsurl.'rt/Admin/CustomFields/Modify.html?Create=1&LookupType=RT%3A%3AClass-RT%3A%3AArticle', '' ],
;

tie my %config_ticketing_articles, 'Tie::IxHash',
  'Classes'       => [ \%config_ticketing_articles_classes, '' ],
  'Custom Fields' => [ \%config_ticketing_articles_customfields, '' ],
;

tie my %config_ticketing, 'Tie::IxHash',
  'Ticketing Users'      => [ $fsurl.'rt/Admin/Users', 'Edit ticketing users' ], #XXX to be unified
  'Ticketing Groups'     => [ \%config_ticketing_groups, 'View/Edit ticketing groups and group membership' ], #XXX to be unified
  'Ticketing Queues'     => [ \%config_ticketing_queues, 'View/Edit ticketing queues and queue-specific properties' ], 
  'Ticket Custom Fields' => [ \%config_ticketing_customfields, 'View/Edit ticketing custom fields' ], 
  'Ticketing Global'     => [ $fsurl.'rt/Admin/Global', 'View/Edit ticketing configuration applicable to all queues' ], #XXX the individual items
  'Ticketing Articles'   => [ \%config_ticketing_articles, '' ],
  #"System Configuraiton"?  useless, just makes people report errors about missing Module::Versions::Report #'Ticketing Tools'     => [ $fsurl.'rt/Admin/Tools', '' ], 
;

tie my %config_nms, 'Tie::IxHash',
  'View/Edit virtual ports' => [ $fsurl.'browse/torrus_srvderive.html', '' ],
;

tie my %config_misc, 'Tie::IxHash';
$config_misc{'Message templates'} = [ $fsurl.'browse/msg_template/email.html', 'Templates for customer notices' ]
  if $curuser->access_right(['View templates', 'View global templates',
                             'Edit templates', 'Edit global templates', ]);
$config_misc{'Advertising sources'} = [ $fsurl.'browse/part_referral.html', 'Where a customer heard about your service.' ]
  if $curuser->access_right('Edit advertising sources')
  || $curuser->access_right('Edit global advertising sources');
$config_misc{'Custom fields'} = [ $fsurl.'browse/part_virtual_field.html', 'Locally defined fields', ]
  if $curuser->access_right('Edit custom fields');
$config_misc{'Translation strings'} = [ $fsurl.'browse/msgcat.html', 'Translations and other customizable labels for each locale' ]
  if $curuser->access_right('Configuration');
$config_misc{'Inventory classes and inventory'} = [ $fsurl.'browse/inventory_class.html', 'Setup inventory classes and stock inventory' ]
  if $curuser->access_right('Edit inventory')
  || $curuser->access_right('Edit global inventory')
  || $curuser->access_right('Configuration');

$config_misc{'Upload targets'} = [ $fsurl.'browse/upload_target.html', 'Billing and payment upload destinations' ]
  if $curuser->access_right('Configuration');

$config_misc{'System log emails'} = [ $fsurl.'browse/log_email.html', 'Configure conditions for sending email when logging' ]
  if $curuser->access_right('View system logs')
  || $curuser->access_right('Configuration');

tie my %config_menu, 'Tie::IxHash';
if ( $curuser->access_right('Configuration' ) ) {
  %config_menu = (
    'Settings'      => [ $fsurl.'config/config-view.cgi', '' ],
    'separator'     => '', #its a separator!
    'Companies'     => [ \%config_agent, '' ],
  );
}

$config_menu{'Sales People'}  = [ \%config_sales, '' ]
  if $curuser->access_right('Edit sales people');

if ( $curuser->access_right('Configuration' ) ) {
  $config_menu{'Employees'}  = [ \%config_employees, '' ];
  $config_menu{'separator2'} = ''; #its a separator!
  $config_menu{'Customers'}  = [ \%config_cust, '' ];
    #or this? 'Customers and Contacts'
}

$config_menu{'Packages'} = [ \%config_pkg, '' ]
  if    $curuser->access_right('Configuration' )
     || $curuser->access_right('Edit package definitions')
     || $curuser->access_right('Edit global package definitions');

if ( $curuser->access_right('Configuration') ) {
  $config_menu{'Services'} = [ \%config_export_svc, '' ];
  $config_menu{separator3} = '';
}

tie my %config_vendor, 'Tie::IxHash',
  'Vendor classes' => [ $fsurl.'browse/vend_class.html', '' ],
  'Vendors'        => [ $fsurl.'browse/vend_main.html', '' ],
;

if ( $curuser->access_right('Configuration') ) {
  $config_menu{'Vendors'} = [ \%config_vendor, '' ];
  $config_menu{separator4} = '';
}

$config_menu{'Billing'} = [ \%config_billing, '' ]
  if keys %config_billing;
$config_menu{'Ticketing'} = [ \%config_ticketing, '' ]
  if $conf->config('ticket_system')
  && FS::TicketSystem->access_right(\%session, 'ShowConfigTab');
$config_menu{'Network Monitoring'} = [ \%config_nms, '' ]
  if $curuser->access_right('Configure network monitoring')
  && $conf->config('network_monitoring_system') eq 'Torrus_Internal';

if ( $curuser->access_right([ 'Configuration',
                              'View templates',
                              'View global templates',
                              'Edit templates',
                              'Edit global templates',
                           ])
   ) {
  $config_menu{separator9} = '' if keys %config_menu;
  $config_menu{'Miscellaneous'} = [ \%config_misc, ''    ];
}


my $wiki = 'http://www.freeside.biz/mediawiki/index.php';
my $doc_link = $conf->config('support-key')
                 ? "$wiki/Supported:Documentation"
                 : $curuser->access_right('Configuration')
                   ? "$wiki/Freeside:4:Documentation"
                   : "$wiki/Freeside:2.1:Documentation:User"; #no page for other versions yet :/

eval "use RT;"
  if $conf->config('ticket_system') eq 'RT_Internal';

tie my %help_menu, 'Tie::IxHash';
my $agentnum = $conf->config('brand-agent');
if ( $agentnum ) {
  my $company_name = $conf->config('company_name', $agentnum);
  $help_menu{"About $company_name"} = [ "javascript:about_freeside()", '' ];
} else {
  $help_menu{'Billing documentation'} = [ $doc_link, 'Freeside documentation' ];
  $help_menu{'Ticketing documentation'} = [ 'http://wiki.bestpractical.com/', 'Request Tracker Wiki' ]
    if $conf->config('ticket_system') eq 'RT_Internal';
  $help_menu{'Networking monitoring documentation'} = [ 'http://torrus.org/userguide.pod.html', 'Torrus User Guide' ]
    if $conf->config('network_monitoring_system') eq 'Torrus_Internal';
  $help_menu{'separator'} = '';
  $help_menu{"About Freeside v$FS::VERSION"} = [ "javascript:about_freeside()", '' ];
  $help_menu{"About RT v$RT::VERSION"} = [ 'http://www.bestpractical.com/rt', 'Request Tracker Homepage' ]
    if $conf->config('ticket_system') eq 'RT_Internal';
  $help_menu{"About Torrus v1.0.9"} = [ 'http://www.torrus.org/', 'Torrus Homepage' ] #XXX manual version
    if $conf->config('network_monitoring_system') eq 'Torrus_Internal';
}


tie my %menu, 'Tie::IxHash';

if ( $conf->config('menu-prepend_links')) {
  my @links = split(/\n/, $conf->config('menu-prepend_links'));
  foreach my $link (@links) {
    $link =~ /^\s*(\S+)\s+(.*?)(\s*\(([^\)]*)\))?$/ or next;
    my($url, $label, $alt) = ($1, $2, $4);
    $menu{$label} = [ $url, $alt ];
  }
}

$menu{'Billing Main'} = [ $fsurl, 'Billing start page', ];

if ( $conf->config('ticket_system') ) {
  $menu{'Ticketing Main'} =
    [ 
      ( $conf->config('ticket_system') eq 'RT_External'
        ? FS::TicketSystem->baseurl()
        : $fsurl.'rt/'
      ),
      'Ticketing start page',
    ],
}

if ( $conf->config('network_monitoring_system') eq 'Torrus_Internal' &&
  $curuser->access_right('Configure network monitoring') ) {
  $menu{'Network Main'} =
    [ $fsurl.'torrus/main', 'Network monitoring start page' ],
}

$menu{'New prospect'} = [ $fsurl.'edit/prospect_main.html', 'Add a new prospect' ]
  if $curuser->access_right('New prospect');
$menu{'New customer'} = [ $fsurl.'edit/cust_main.cgi', 'Add a new customer' ]
  if $curuser->access_right('New customer');
$menu{'Reports'} = [ \%report_menu, 'Lists, reporting and graphing' ]
  if keys %report_menu;
$menu{'Tools'} = [ \%tools_menu, 'Tools' ]
  if keys %tools_menu;
$menu{'Configuration'} = [ \%config_menu, 'Configuration and setup' ]
  if $curuser->access_right([ 'Configuration',
                              'Edit package definitions',
                              'Edit global package definitions',
                              'Edit billing events',
                              'Edit global billing events',
                              'Dialup configuration',
                              'Wireless broadband configuration',
                              'Phone configuration',
                              'Alarm configuration',
                              'Alarm global configuration',
                              'Edit advertising sources',
                              'Edit global advertising sources',
                              'View templates',
                              'View global templates',
                              'Edit templates',
                              'Edit global templates',
                           ]);
$menu{'Help'} = [ \%help_menu, '' ];


use vars qw($gmenunum);
$gmenunum = 0;

sub submenu {
  my($submenu, $title) = @_;
  my $menunum = $gmenunum++;

  #return two args: html, menuname

  "var myMenu$menunum = new WebFXMenu;\n".
  #"myMenu$menunum.useAutoPosition = true;\n".
#  "myMenu$menunum.emptyText = '$title';\n".
  "myMenu$menunum.emptyText = '';\n".

  (
    join("\n", map {

      if ( !ref( $submenu->{$_} ) ) {

        "myMenu$menunum.add(new WebFXMenuSeparator());";

      } else {

        my($url_or_submenu, $tooltip ) = @{ $submenu->{$_} };
        if ( ref($url_or_submenu) ) {

          my($subhtml, $submenuname ) = submenu($url_or_submenu, $_); #mmm, recursion

          "$subhtml\n".
          "myMenu$menunum.add(new WebFXMenuItem(\"".mt($_)."\", null, \"".mt($tooltip)."\", $submenuname ));";

        } else {

          "myMenu$menunum.add(new WebFXMenuItem(\"".mt($_)."\", \"$url_or_submenu\", \"".mt($tooltip)."\" ));";

        }

      }

    } keys %$submenu )
  ). "\n".
  "myMenu$menunum.width = 256;\n",

  "myMenu$menunum";

}

</%init>

