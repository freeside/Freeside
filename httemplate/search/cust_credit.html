<%
   my $title = 'Credit Search Results';
   #my( $count_query, $sql_query );

   my @search = ();

   if ( $cgi->param('otaker') && $cgi->param('otaker') =~ /^([\w\.\-]+)$/ ) {
     push @search, "otaker = '$1'";
   }

   if ( $cgi->param('agentnum') && $cgi->param('agentnum') =~ /^(\d+)$/ ) {
     push @search, "agentnum = $1";
     my $agent = qsearchs('agent', { 'agentnum' => $1 } );
     die "unknown agentnum $1" unless $agent;
     $title = $agent->agent. " $title";
   }

   #false laziness with cust_pkg.cgi and cust_pay.cgi
   if ( $cgi->param('beginning')
        && $cgi->param('beginning') =~ /^([ 0-9\-\/]{1,10})$/ ) {
     my $beginning = str2time($1);
     push @search, "_date >= $beginning ";
   }
   if ( $cgi->param('ending')
             && $cgi->param('ending') =~ /^([ 0-9\-\/]{1,10})$/ ) {
     my $ending = str2time($1) + 86399;
     push @search, " _date <= $ending ";
   }

   if ( $cgi->param('begin')
        && $cgi->param('begin') =~ /^(\d+)$/ ) {
     push @search, "_date >= $1 ";
   }
   if ( $cgi->param('end')
             && $cgi->param('end') =~ /^(\d+)$/ ) {
     push @search, " _date < $1 ";
   }

   my $where = scalar(@search)
                 ? 'WHERE '. join(' AND ', @search)
                 : '';

   my $count_query = 'SELECT COUNT(*), SUM(amount) '.
                     'FROM cust_credit LEFT JOIN cust_main USING ( custnum ) '.
                     $where;

   my $sql_query   = {
     'table'     => 'cust_credit',
     'select'    => 'cust_credit.*, cust_main.last, cust_main.first, cust_main.company',
     'hashref'   => {},
     'extra_sql' => $where,
     'addl_from' => 'LEFT JOIN cust_main USING ( custnum )',
   };

   my $clink = [ "${p}view/cust_main.cgi?", 'custnum' ];

%><%= include( 'elements/search.html',
                 'title'       => $title,
                 'name'        => 'credits',
                 'query'       => $sql_query,
                 'count_query' => $count_query,
                 'count_addl'  => [ '$%.2f total credited', ],
                 #'redirect'    => $link,
                 'header'      =>
                   [ qw(Amount Date), 'Cust #', 'Contact name',
                     qw(Company By Reason) ],
                 'fields'      => [
                   #'crednum',
                   sub { sprintf('$%.2f', shift->amount ) },
                   sub { time2str('%b %d %Y', shift->_date ) },
                   'custnum',
                   sub { $_[0]->get('last'). ', '. $_[0]->first; },
                   'company',
                   'otaker',
                   'reason',
                 ],
                 'align' => 'rrrllll',
                 'links' => [
                   '',
                   '',
                   $clink,
                   $clink,
                   $clink,
                   '',
                   '',
                 ],
      )
%>
