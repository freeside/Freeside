<% include( 'elements/search.html',
               'title' => $title,
               'name'  => 'call detail records',
               'query' => { 'table'     => 'cdr',
                            'hashref'   => $hashref,
			    'extra_sql' => $qsearch,
			    'order_by'  => 'ORDER BY calldate',
                          },
               'count_query' => $count_query,
               'header' => [ fields('cdr') ], #XXX fill in some nice names
               'fields' => [ fields('cdr') ], #XXX fill in some pretty-print
                                              # processing, etc.
             )
%>
<%init>

die "access denied"
  unless $FS::CurrentUser::CurrentUser->access_right('List rating data');

my $title = 'Call Detail Records';
my $hashref = {};

#process params for CDR search, populate $hashref...
# and fixup $count_query

my @search = ();

###
# freesidestatus
###

if ( $cgi->param('freesidestatus') eq 'NULL' ) {

  my $title = "Unprocessed $title";
  $hashref->{'freesidestatus'} = ''; # Record.pm will take care of it
  push @search, "( freesidestatus IS NULL OR freesidestatus = '' )";

} elsif ( $cgi->param('freesidestatus') =~ /^([\w ]+)$/ ) {

  my $title = "Processed $title";
  $hashref->{'freesidestatus'} = $1;
  push @search, "freesidestatus = '$1'";

}

###
# dates
###

my $str2time_sql = str2time_sql;

my($beginning, $ending) = FS::UI::Web::parse_beginning_ending($cgi);
push @search, "$str2time_sql calldate) >= $beginning ",
              "$str2time_sql calldate) <= $ending";

###
# duration / billsec
###

push @search, FS::UI::Web::parse_lt_gt($cgi, 'duration');
push @search, FS::UI::Web::parse_lt_gt($cgi, 'billsec');

###
# src/dest/charged_party
###

my @qsearch = @search;

if ( $cgi->param('src') =~ /^\s*([\d\-\+\ ]+)\s*$/ ) {
  ( my $src = $1 ) =~ s/\D//g;
  $hashref->{'src'} = $src;
  push @search, "src = '$src'";
}

if ( $cgi->param('dst') =~ /^\s*([\d\-\+ ]+)\s*$/ ) {
  ( my $dst = $1 ) =~ s/\D//g;
  $hashref->{'dst'} = $dst;
  push @search, "dst = '$dst'";
}

if ( $cgi->param('charged_party') =~ /^\s*([\d\-\+\ ]+)\s*$/ ) {
  ( my $charged_party = $1 ) =~ s/\D//g;
  #$hashref->{'charged_party'} = $charged_party;
  #push @search, "charged_party = '$charged_party'";
  #XXX countrycode
  push @search,  " (    charged_party = '$charged_party'
                     OR charged_party = '1$charged_party' ) ";
  push @qsearch, " (    charged_party = '$charged_party'
                    OR charged_party = '1$charged_party' ) ";
}


###
# finish it up
###

my $search = join(' AND ', @search);
$search = "WHERE $search" if $search;

my $count_query = "SELECT COUNT(*) FROM cdr $search";

my $qsearch = join(' AND ', @qsearch);
$qsearch = ( scalar(keys %$hashref) ? ' AND ' : ' WHERE ' ) . $qsearch
  if $qsearch;

</%init>
