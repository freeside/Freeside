<& /elements/header.html, $title &>
<STYLE TYPE="text/css">
table.fcc477part {
  border-collapse: collapse;
  border: 1px #777 solid;
  margin-bottom: 20px;
}
table.fcc477part td {
  padding: 0px 4px;
  border-left: 1px #777 solid;
  border-right: 1px #777 solid;
}
table.fcc477part tbody td {
  text-align: right;
}
table.fcc477part thead tr.head {
  text-align: center;
  vertical-align: top;
  font-weight: bold;
  border-top: 1px #777 solid;
  border-bottom: 1px #777 solid;
}
table.fcc477part thead tr.subhead {
  text-align: center;
  font-weight: bold;
  font-size: small;
  border-top: 1px #777 solid;
  border-bottom: 1px #777 solid;
}
.parttitle {
  font-weight: bold;
  font-size: large;
  float: left;
}
a.download {
  float: right;
}
</STYLE>
% foreach my $partname (@partnames) {
%   $cgi->param('parts', $partname);
%   $cgi->param('type', 'csv');
<table class="fcc477part">
  <caption>
    <span class="parttitle"><% $part_titles->{$partname} %></span>
    <a class="download" href="<% $cgi->self_url %>">Download</a>
  </caption>
%   my $header = ".header_$partname";
%   my $data = $parts{$partname};
  <thead>
    <& $header &>
  </thead>
%   foreach my $row (@$data) {
  <tr>
%     foreach my $item (@$row) {
    <td><% $item %></td>
%     }
  </tr>
%   }
</table>
% } # foreach $partname
<& /elements/footer.html &>
<%init>
die "access denied"
  unless $FS::CurrentUser::CurrentUser->access_right('List packages');

my %parts;
# load from cache if possible
my $session;
if ( $cgi->param('session') =~ /^(\d+)$/ ) {
  $session = $1;
  %parts = %{ $m->cache->get($session) };
} else {
  $session = sprintf('%010d%06d', time, int(rand(1000000)));
  $cgi->param('session', $session);
}

my $agentnum;
if ($cgi->param('agentnum') =~ /^(\d+)$/ ) {
  $agentnum = $1;
}
my $date = parse_datetime($cgi->param('date')) || time;
my @partnames = grep /^\w+$/, $cgi->param('parts');
foreach my $partname (@partnames) {
  $parts{$partname} ||= FS::Report::FCC_477->report( $partname,
    date      => $date,
    agentnum  => $agentnum
  );
}
$m->cache->set($session, \%parts, '1h');

my $title = 'FCC Form 477 Data - ' . time2str('%b %o, %Y', $date);

if ( $cgi->param('type') eq 'csv' ) {
  my $partname = $partnames[0]; # ignore any beyond the first
  my $data = $parts{$partname};
  my $csv = Text::CSV_XS->new({ eol => "\r\n" }); # i think

  my $filename = time2str('%Y-%m-%d', $date) . '-'. $partname . '.csv';
  http_header('Content-Type' => 'text/csv');
  http_header('Content-Disposition' => qq(attachment;filename="$filename"));

  $m->clear_buffer;

  foreach my $row (@$data) {
    $csv->combine(@$row);
    $m->print($csv->string);
  }
  $m->abort;
}

my $part_titles = FS::Report::FCC_477->parts;

</%init>
<%def .header_fbd>
  <TR CLASS="head">
    <TD ROWSPAN=2>Census Block</TD>
    <TD ROWSPAN=2>DBA Name</TD>
    <TD ROWSPAN=2>Technology</TD>
    <TD ROWSPAN=2>Consumer?</TD>
    <TD COLSPAN=2>Advertised Speed (Mbps)</TD>
    <TD ROWSPAN=2>Business?</TD>
    <TD COLSPAN=2>Contractual Speed (Mbps)</TD>
  </TR>
  <TR CLASS="subhead">
    <TD>Down</TD>
    <TD>Up</TD>
    <TD>Down</TD>
    <TD>Up</TD>
  </TR>
</%def>
<%def .header_fbs>
  <TR CLASS="head">
    <TD ROWSPAN=2>Census Tract</TD>
    <TD ROWSPAN=2>Technology</TD>
    <TD COLSPAN=2>Speed (Mbps)</TD>
    <TD COLSPAN=2>Subscriptions</TD>
  </TR>
  <TR CLASS="subhead">
    <TD>Down</TD>
    <TD>Up</TD>
    <TD>Total</TD>
    <TD>Consumer</TD>
  </TR>
</%def>
<%def .header_fvs>
  <TR CLASS="head">
    <TD ROWSPAN=2>Census Tract</TD>
    <TD ROWSPAN=2>VoIP?</TD>
    <TD COLSPAN=2>Lines/Subscriptions</TD>
  </TR>
  <TR CLASS="subhead">
    <TD>Total</TD>
    <TD>Consumer</TD>
  </TR>
</%def>
<%def .header_lts>
  <TR CLASS="head">
    <TD ROWSPAN=3>State</TD>
    <TD COLSPAN=2>Wholesale</TD>
    <TD COLSPAN=12>End User Lines</TD>
  </TR>
  <TR CLASS="subhead">
    <TD ROWSPAN=2>VGEs</TD>
    <TD ROWSPAN=2>UNE-Ls</TD>

    <TD ROWSPAN=2>Total</TD>
    <TD ROWSPAN=2>With Broadband</TD>
    <TD COLSPAN=2>Consumer</TD>
    <TD COLSPAN=2>Business</TD>

    <TD COLSPAN=3>Local Loop</TD>

    <TD COLSPAN=3>Special Media</TD>
  </TR>

  <TR CLASS="subhead">
    <TD> </TD>
    <TD>+LD</TD>
    <TD> </TD>
    <TD>+LD</TD>

    <TD>Owned</TD>
    <TD>UNE-L</TD>
    <TD>Resale</TD>

    <TD>Fiber</TD>
    <TD>Coaxial</TD>
    <TD>Wireless</TD>
  </TR>
</%def>
<%def .header_voip>
  <TR CLASS="head">
    <TD ROWSPAN=2>State</TD>
    <TD COLSPAN=2>VoIP OTT</TD>
    <TD COLSPAN=8>VoIP Non-OTT</TD>
  </TR>
  <TR CLASS="subhead">
    <TD ROWSPAN=2>Total</TD>
    <TD ROWSPAN=2>Consumer</TD>

    <TD ROWSPAN=2>Total</TD>
    <TD ROWSPAN=2>Consumer</TD>
    <TD ROWSPAN=2>Bundled</TD>
    <TD COLSPAN=5>Media Type</TD>
  </TR>
  <TR CLASS="subhead">
    <TD>Copper</TD>
    <TD>Fiber</TD>
    <TD>Coaxial</TD>
    <TD>Wireless</TD>
    <TD>Other</TD>
  </TR>
</%def>
<%def .header_mbs>
%# unimplemented
  <TR CLASS="head">
    <TD ROWSPAN=2>State</TD>
    <TD COLSPAN=2>Speed (Mbps)</TD>
    <TD COLSPAN=2>Subscriptions</TD>
  </TR>
  <TR CLASS="subhead">
    <TD>Down</TD>
    <TD>Up</TD>
    <TD>Total</TD>
    <TD>Consumer</TD>
  </TR>
</%def>
<%def .header_mvs>
%# unimplemented
  <TR CLASS="head">
    <TD ROWSPAN=2>State</TD>
    <TD COLSPAN=2>Subscriptions</TD>
  </TR>
  <TR CLASS="subhead">
    <TD>Total</TD>
    <TD>Direct</TD>
  </TR>
</%def>

